<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×›×¨× ×× ×’×³×¨</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --earth:#1A0F05;--bark:#4A2808;--vine:#3D6B1E;--leaf:#5E9A2E;
  --light-vine:#EBF4DF;--harvest:#B8720A;--gold:#DBA030;
  --cream:#F6EFE2;--parch:#E8D9BF;--stone:#9A8070;--mist:#F8F4EE;
  --red:#B83025;--blue:#1E6FA0;--purple:#6A3DB8;
  --sh:rgba(26,15,5,.10);--dsh:rgba(26,15,5,.22);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Heebo',sans-serif;background:var(--mist);color:var(--earth);min-height:100vh;direction:rtl}

/* â”€â”€ LOGIN â”€â”€ */
#ls{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 25% 55%,#2d5510 0%,#1A0F05 65%,#0a0603 100%);overflow:hidden;position:relative}
.vbg{position:absolute;inset:0;display:flex;flex-wrap:wrap;font-size:4.5rem;opacity:.05;pointer-events:none;line-height:1.1;overflow:hidden}
.lc{background:var(--cream);border-radius:22px;padding:46px 38px;width:400px;max-width:94vw;
  box-shadow:0 30px 80px rgba(0,0,0,.55);position:relative;z-index:1;animation:up .5s ease}
@keyframes up{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:translateY(0)}}
.llogo{text-align:center;margin-bottom:28px}
.llogo .ic{font-size:3.5rem;display:block;margin-bottom:4px}
.llogo h1{font-size:1.9rem;font-weight:900;color:var(--bark)}
.llogo p{font-size:.82rem;color:var(--stone);margin-top:2px}
.fg{margin-bottom:14px}.fg label{display:block;font-weight:700;font-size:.8rem;color:var(--bark);margin-bottom:5px}
.fg input{width:100%;padding:10px 13px;border:2px solid var(--parch);border-radius:9px;
  font-family:'Heebo',sans-serif;font-size:.92rem;background:white;color:var(--earth);direction:rtl;transition:border-color .2s}
.fg input:focus{outline:none;border-color:var(--vine)}
.lerr{background:#fdecea;border:1px solid #f5c6cb;color:var(--red);padding:8px 13px;border-radius:7px;font-size:.83rem;margin-top:9px;display:none}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border:none;border-radius:8px;
  font-family:'Heebo',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .16s;text-decoration:none}
.btn-full{width:100%;justify-content:center;font-size:.97rem;padding:12px}
.btn-p{background:var(--vine);color:white}.btn-p:hover{background:#2d5012;transform:translateY(-1px);box-shadow:0 4px 14px var(--sh)}
.btn-s{background:var(--parch);color:var(--earth)}.btn-s:hover{background:#d5c4a5}
.btn-d{background:var(--red);color:white}.btn-d:hover{background:#922218}
.btn-g{background:var(--harvest);color:white}.btn-g:hover{background:#8f5506}
.btn-sm{padding:5px 11px;font-size:.77rem}.btn-xs{padding:3px 8px;font-size:.72rem;border-radius:6px}

/* â”€â”€ APP SHELL â”€â”€ */
#app{display:none;min-height:100vh}
.top{background:linear-gradient(90deg,var(--earth),var(--bark));color:white;padding:0 20px;height:58px;
  display:flex;align-items:center;justify-content:space-between;box-shadow:0 3px 12px var(--dsh);position:sticky;top:0;z-index:200}
.brand{display:flex;align-items:center;gap:8px;font-size:1.1rem;font-weight:900}
.topright{display:flex;align-items:center;gap:12px;font-size:.82rem}
.topright strong{color:var(--gold)}

.layout{display:flex;min-height:calc(100vh - 58px)}
.sb{width:200px;background:var(--cream);border-left:1px solid var(--parch);padding:14px 0;flex-shrink:0;box-shadow:2px 0 5px var(--sh)}
.slbl{padding:4px 16px 2px;font-size:.66rem;font-weight:800;color:var(--stone);text-transform:uppercase;letter-spacing:1.2px}
.nv{display:flex;align-items:center;gap:8px;padding:9px 16px;cursor:pointer;font-weight:500;font-size:.85rem;
  color:var(--bark);transition:all .14s;border-right:3px solid transparent}
.nv:hover{background:var(--parch);color:var(--earth)}
.nv.on{background:linear-gradient(90deg,rgba(61,107,30,.14),transparent);color:var(--vine);border-right-color:var(--vine);font-weight:700}
.nic{font-size:1rem;width:19px;text-align:center}
.cnt{flex:1;padding:24px;overflow-y:auto;background:var(--mist)}

/* â”€â”€ PAGES â”€â”€ */
.pg{display:none;animation:fi .22s ease}
.pg.on{display:block}
@keyframes fi{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.ph{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;flex-wrap:wrap;gap:10px}
.pt{font-size:1.5rem;font-weight:900;color:var(--earth)}
.pt small{display:block;font-size:.79rem;font-weight:400;color:var(--stone);margin-top:1px}

/* â”€â”€ CARDS â”€â”€ */
.card{background:white;border-radius:12px;box-shadow:0 2px 9px var(--sh);padding:20px;margin-bottom:16px}
.ct{font-size:.93rem;font-weight:700;color:var(--earth);margin-bottom:12px;border-bottom:2px solid var(--parch);padding-bottom:8px;display:flex;align-items:center;gap:6px}

/* â”€â”€ GRID â”€â”€ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:13px}

/* â”€â”€ STAT CARDS â”€â”€ */
.sc{background:white;border-radius:12px;box-shadow:0 2px 9px var(--sh);padding:16px 18px;
  display:flex;align-items:center;gap:13px;transition:transform .18s;border-right:4px solid}
.sc:hover{transform:translateY(-2px)}
.sc-ic{font-size:1.9rem}.sc-num{font-size:1.75rem;font-weight:900;line-height:1}.sc-lbl{font-size:.74rem;color:var(--stone);margin-top:2px}
.cv{border-right-color:var(--vine)}.cg{border-right-color:var(--harvest)}.cb{border-right-color:var(--blue)}.cr{border-right-color:var(--red)}

/* â”€â”€ TABLE â”€â”€ */
.tw{overflow-x:auto;border-radius:8px;border:1px solid var(--parch)}
table{width:100%;border-collapse:collapse;font-size:.84rem}
thead th{background:var(--cream);padding:10px 13px;font-weight:700;color:var(--bark);text-align:right;border-bottom:2px solid var(--parch);white-space:nowrap}
tbody td{padding:9px 13px;border-bottom:1px solid #f0e5d4;color:var(--earth)}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover{background:var(--mist)}

/* â”€â”€ BADGE â”€â”€ */
.bdg{display:inline-block;padding:2px 8px;border-radius:18px;font-size:.71rem;font-weight:700}
.bv{background:var(--light-vine);color:var(--vine)}.bg{background:#fff3cd;color:#7a5c00}
.bb{background:#d1ecf1;color:#0a4e62}.br{background:#f8d7da;color:#6e1010}.bk{background:#e2e3e5;color:#3a3c3e}
.bo{background:#ffe8d0;color:#7a3800}.bp{background:#ede0ff;color:#4a1f8f}

/* â”€â”€ FORM â”€â”€ */
.frow{display:flex;gap:9px;align-items:flex-end;flex-wrap:wrap;margin-bottom:12px}
.ff{display:flex;flex-direction:column;gap:3px;flex:1;min-width:120px}
.ff label{font-size:.77rem;font-weight:700;color:var(--bark)}
.ff input,.ff select,.ff textarea{padding:7px 10px;border:1.5px solid var(--parch);border-radius:7px;
  font-family:'Heebo',sans-serif;font-size:.84rem;background:white;color:var(--earth);direction:rtl;transition:border-color .2s}
.ff input:focus,.ff select:focus,.ff textarea:focus{outline:none;border-color:var(--vine)}
.ff textarea{resize:vertical;min-height:56px}

/* â”€â”€ CHIPS â”€â”€ */
.chips{display:flex;flex-wrap:wrap;gap:5px}
.chip{display:flex;align-items:center;gap:4px;padding:4px 10px;border:1.5px solid var(--parch);border-radius:18px;
  cursor:pointer;font-size:.8rem;font-weight:600;color:var(--earth);transition:all .13s;background:white;user-select:none}
.chip.sel{background:var(--vine);color:white;border-color:var(--vine)}
.chip.drv{background:var(--blue);color:white;border-color:var(--blue)}

/* â”€â”€ MODAL â”€â”€ */
.mo{position:fixed;inset:0;background:rgba(26,15,5,.62);display:none;align-items:center;justify-content:center;z-index:1000;padding:14px}
.mo.open{display:flex;animation:fi .18s ease}
.md{background:white;border-radius:16px;padding:26px 28px;width:100%;max-width:680px;max-height:93vh;overflow-y:auto;box-shadow:0 16px 52px rgba(0,0,0,.35)}
.mh{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.mttl{font-size:1.15rem;font-weight:800;color:var(--earth)}
.mcl{background:none;border:none;font-size:1.35rem;cursor:pointer;color:var(--stone);padding:2px 6px;border-radius:5px}
.mcl:hover{background:var(--parch)}
.mft{display:flex;gap:8px;justify-content:flex-end;margin-top:18px;padding-top:14px;border-top:1px solid var(--parch)}

/* â”€â”€ TOGGLE â”€â”€ */
.tgl{position:relative;width:42px;height:21px;flex-shrink:0}
.tgl input{opacity:0;width:0;height:0}
.tsl{position:absolute;inset:0;background:var(--stone);border-radius:21px;cursor:pointer;transition:background .2s}
.tsl:before{content:'';position:absolute;width:15px;height:15px;left:3px;top:3px;background:white;border-radius:50%;transition:transform .2s}
.tgl input:checked+.tsl{background:var(--vine)}
.tgl input:checked+.tsl:before{transform:translateX(21px)}

/* â”€â”€ TOAST â”€â”€ */
.tst{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--earth);
  color:white;padding:10px 20px;border-radius:9px;font-weight:700;font-size:.85rem;z-index:9999;
  box-shadow:0 5px 20px rgba(0,0,0,.3);transition:transform .28s}
.tst.show{transform:translateX(-50%) translateY(0)}
.tst.ok{background:var(--vine)}.tst.er{background:var(--red)}

/* â”€â”€ BARS â”€â”€ */
.brow{display:flex;align-items:center;gap:8px;margin-bottom:9px}
.bname{width:100px;font-size:.8rem;font-weight:600;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.btrk{flex:1;height:20px;background:var(--parch);border-radius:4px;overflow:hidden;position:relative}
.bfil{height:100%;border-radius:4px;display:flex;align-items:center;padding-right:7px;
  font-size:.72rem;font-weight:700;color:white;transition:width .55s;min-width:2px}
.bval{font-size:.79rem;font-weight:700;color:var(--bark);width:55px;text-align:left;flex-shrink:0}

/* â”€â”€ PROGRESS â”€â”€ */
.pb{height:8px;background:var(--parch);border-radius:4px;overflow:hidden;margin-top:4px}
.pf{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--vine),var(--leaf));transition:width .5s}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;gap:3px;background:var(--parch);border-radius:8px;padding:3px;margin-bottom:16px;width:fit-content;flex-wrap:wrap}
.tab{padding:6px 15px;border-radius:6px;cursor:pointer;font-weight:600;font-size:.82rem;color:var(--bark);transition:all .16s}
.tab.on{background:white;color:var(--vine);box-shadow:0 2px 6px var(--sh)}

/* â”€â”€ WORKER CARDS â”€â”€ */
.wsc{background:white;border-radius:12px;box-shadow:0 2px 9px var(--sh);margin-bottom:12px;overflow:hidden;border-right:4px solid var(--vine)}
.wsch{padding:11px 15px;background:linear-gradient(135deg,var(--vine),var(--leaf));color:white;display:flex;align-items:center;justify-content:space-between}
.wscb{padding:12px 15px}
.ir{display:flex;gap:7px;align-items:flex-start;margin-bottom:6px;font-size:.84rem}
.ir .lb{color:var(--stone);font-weight:600;width:80px;flex-shrink:0}
.maplnk{display:inline-flex;align-items:center;gap:3px;color:var(--blue);font-size:.76rem;font-weight:700;
  text-decoration:none;background:#deedf8;padding:2px 8px;border-radius:14px;transition:background .18s}
.maplnk:hover{background:#b8d8f0}

/* â”€â”€ HERO â”€â”€ */
.hero{background:linear-gradient(135deg,var(--vine),var(--earth));border-radius:14px;padding:22px;
  color:white;margin-bottom:20px;display:flex;align-items:center;gap:16px}
.hav{width:54px;height:54px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:1.7rem;border:3px solid rgba(255,255,255,.38);flex-shrink:0}
.hi h2{font-size:1.3rem;font-weight:800}.hi p{font-size:.81rem;opacity:.82;margin-top:2px}

/* â”€â”€ TOMORROW HIGHLIGHT â”€â”€ */
.tmrw-card{background:linear-gradient(135deg,var(--harvest),var(--gold));border-radius:14px;color:white;padding:20px;margin-bottom:18px}
.tmrw-card .ir .lb{color:rgba(255,255,255,.75)}
.tmrw-card a.maplnk{background:rgba(255,255,255,.25);color:white}
.tmrw-card a.maplnk:hover{background:rgba(255,255,255,.4)}

/* â”€â”€ TREE ENTRY TABLE â”€â”€ */
.trt td,.trt th{padding:7px 9px;font-size:.82rem}
.trt input[type=number]{width:74px;padding:4px 7px;border:1.5px solid var(--parch);border-radius:5px;
  font-family:'Heebo',sans-serif;font-size:.82rem;text-align:center;background:white}
.trt input[type=number]:focus{outline:none;border-color:var(--vine)}

/* â”€â”€ MONTHLY MINI CHART â”€â”€ */
.month-chart{display:flex;align-items:flex-end;gap:4px;height:80px;padding:4px 0}
.mc-bar{flex:1;background:var(--light-vine);border-radius:3px 3px 0 0;position:relative;transition:background .2s;min-width:12px;cursor:default}
.mc-bar:hover{background:var(--vine)}.mc-bar:hover .mc-tt{display:block}
.mc-tt{display:none;position:absolute;bottom:105%;left:50%;transform:translateX(-50%);background:var(--earth);
  color:white;padding:3px 8px;border-radius:5px;font-size:.7rem;white-space:nowrap;z-index:10}
.mc-lbl{font-size:.65rem;text-align:center;color:var(--stone);margin-top:3px}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:36px 14px;color:var(--stone)}
.emj{font-size:2.3rem;margin-bottom:8px}

/* â”€â”€ LEADERBOARD â”€â”€ */
.lbrow{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--parch)}
.lbrow:last-child{border-bottom:none}
.lbrank{font-size:1.4rem;width:30px;text-align:center;flex-shrink:0}
.lbav{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:.9rem;color:white;flex-shrink:0}
.lbinfo{flex:1}
.lbname{font-weight:700;font-size:.88rem}
.lbsub{font-size:.74rem;color:var(--stone)}
.lbtrees{font-size:1.1rem;font-weight:900;color:var(--vine)}

.sep{border:none;border-top:1.5px solid var(--parch);margin:14px 0}
.sumbox{background:var(--light-vine);border:1.5px solid var(--vine);border-radius:9px;padding:11px 14px;margin-top:12px;font-size:.86rem}
.sumbox strong{color:var(--vine)}

/* tomorrow badge */
.tmrw-badge{background:var(--harvest);color:white;padding:2px 10px;border-radius:14px;font-size:.77rem;font-weight:700}

@media(max-width:768px){
  .sb{width:48px}.sb .nv span:not(.nic){display:none}.slbl{display:none}
  .g4{grid-template-columns:1fr 1fr}.g3{grid-template-columns:1fr}.g2{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="ls">
  <div class="vbg" id="vbg"></div>
  <div class="lc">
    <div class="llogo"><span class="ic">ğŸ‡</span><h1>×›×¨× ×× ×’×³×¨</h1><p>××¢×¨×›×ª × ×™×”×•×œ ×–××™×¨×ª ×’×¤× ×™×</p></div>
    <div class="fg"><label>×©× ××©×ª××©</label><input id="lu" type="text" placeholder="×©× ××©×ª××©" /></div>
    <div class="fg"><label>×¡×™×¡××”</label><input id="lp" type="password" placeholder="×¡×™×¡××”" onkeydown="if(event.key==='Enter')login()" /></div>
    <button class="btn btn-p btn-full" style="margin-top:8px" onclick="login()">ğŸ” ×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
    <div class="lerr" id="lerr">×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×</div>
    <p style="text-align:center;margin-top:16px;font-size:.73rem;color:var(--stone)">
      ×× ×”×œ: <strong>admin / admin123</strong> &nbsp;|&nbsp; ×¢×•×‘×“: <strong>david / 1234</strong>
    </p>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="top">
    <div class="brand">ğŸ‡ <span>×›×¨× ×× ×’×³×¨</span></div>
    <div class="topright">×©×œ×•×, <strong id="tu">-</strong><button class="btn btn-s btn-sm" onclick="logout()">×™×¦×™××”</button></div>
  </div>
  <div class="layout">
    <div class="sb">
      <div id="anv">
        <div style="height:8px"></div>
        <div class="slbl">× ×™×”×•×œ</div>
        <div class="nv on" onclick="go('dash')" id="n-dash"><span class="nic">ğŸ“Š</span><span>×“×©×‘×•×¨×“</span></div>
        <div class="nv" onclick="go('sched')" id="n-sched"><span class="nic">ğŸ“‹</span><span>×¡×™×“×•×¨ ×¢×‘×•×“×”</span></div>
        <div class="nv" onclick="go('workers')" id="n-workers"><span class="nic">ğŸ‘·</span><span>×¢×•×‘×“×™×</span></div>
        <div class="nv" onclick="go('analytics')" id="n-analytics"><span class="nic">ğŸ“ˆ</span><span>× ×™×ª×•×— × ×ª×•× ×™×</span></div>
      </div>
      <div id="wnv" style="display:none">
        <div style="height:8px"></div>
        <div class="slbl">××™×©×™</div>
        <div class="nv on" onclick="go('myshifts')" id="n-myshifts"><span class="nic">ğŸ“…</span><span>×”××©××¨×•×ª ×©×œ×™</span></div>
        <div class="nv" onclick="go('mystats')" id="n-mystats"><span class="nic">ğŸ“ˆ</span><span>×”×¡×˜×˜×™×¡×˜×™×§×” ×©×œ×™</span></div>
      </div>
    </div>
    <div class="cnt">

      <!-- â•â• DASHBOARD â•â• -->
      <div class="pg on" id="pg-dash">
        <div class="ph">
          <div class="pt">×“×©×‘×•×¨×“ <small id="ddate"></small></div>
          <div id="tmrw-alert"></div>
        </div>
        <div class="g4" style="margin-bottom:20px">
          <div class="sc cv"><div class="sc-ic">ğŸ‘·</div><div><div class="sc-num" id="d-w">0</div><div class="sc-lbl">×¢×•×‘×“×™×</div></div></div>
          <div class="sc cg"><div class="sc-ic">ğŸ“‹</div><div><div class="sc-num" id="d-s">0</div><div class="sc-lbl">×¡×”×´×› ××©××¨×•×ª</div></div></div>
          <div class="sc cb"><div class="sc-ic">ğŸŒ¿</div><div><div class="sc-num" id="d-t">0</div><div class="sc-lbl">×¢×¦×™× ×”×©×‘×•×¢</div></div></div>
          <div class="sc cr"><div class="sc-ic">ğŸ’°</div><div><div class="sc-num" id="d-r">â‚ª0</div><div class="sc-lbl">×”×›× ×¡×•×ª ×”×©×‘×•×¢</div></div></div>
        </div>
        <div class="g2">
          <div class="card"><div class="ct">ğŸ† ×“×™×¨×•×’ ×¢×¦×™× â€“ ×”×©×‘×•×¢</div><div id="d-lb"></div></div>
          <div class="card"><div class="ct">ğŸ“‹ ××©××¨×•×ª ×§×¨×•×‘×•×ª</div><div id="d-up"></div></div>
        </div>
      </div>

      <!-- â•â• SCHEDULE â•â• -->
      <div class="pg" id="pg-sched">
        <div class="ph">
          <div class="pt">×¡×™×“×•×¨ ×¢×‘×•×“×” <small>×œ×¤×™ ×™×•×</small></div>
          <button class="btn btn-p" onclick="openNewShift()">â• ×¡×™×“×•×¨ ×—×“×©</button>
        </div>
        <!-- Date navigator -->
        <div class="card" style="padding:12px 16px;margin-bottom:14px">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <button class="btn btn-s btn-sm" onclick="schedNav(-1)">â—€ ×™×•× ×§×•×“×</button>
            <input type="date" id="sched-date" style="padding:6px 10px;border:1.5px solid var(--parch);border-radius:7px;font-family:'Heebo',sans-serif;font-size:.88rem;background:white;color:var(--earth);direction:rtl" oninput="renderSched()" />
            <button class="btn btn-s btn-sm" onclick="schedNav(1)">×™×•× ×”×‘× â–¶</button>
            <button class="btn btn-s btn-sm" onclick="document.getElementById('sched-date').value=td();renderSched()">×”×™×•×</button>
            <button class="btn btn-g btn-sm" onclick="document.getElementById('sched-date').value=tmr();renderSched()">××—×¨</button>
            <button class="btn btn-s btn-sm" onclick="document.getElementById('sched-date').value='';renderSched()">×›×œ ×”×¡×™×“×•×¨×™×</button>
          </div>
        </div>
        <div id="sl"></div>
      </div>

      <!-- â•â• WORKERS â•â• -->
      <div class="pg" id="pg-workers">
        <div class="ph">
          <div class="pt">×¢×•×‘×“×™× <small>× ×™×”×•×œ ××©×ª××©×™×</small></div>
          <button class="btn btn-p" onclick="openNewWorker()">â• ×¢×•×‘×“ ×—×“×©</button>
        </div>
        <div class="card">
          <div class="tw"><table>
            <thead><tr><th>×©×</th><th>×©× ××©×ª××©</th><th>×ª×¤×§×™×“</th><th>×¨×›×‘</th><th>××©××¨×•×ª</th><th>×¢×¦×™×</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
            <tbody id="wtb"></tbody>
          </table></div>
        </div>
      </div>

      <!-- â•â• ANALYTICS â•â• -->
      <div class="pg" id="pg-analytics">
        <div class="ph"><div class="pt">× ×™×ª×•×— × ×ª×•× ×™× <small>×¡×˜×˜×™×¡×˜×™×§×” ××œ××” ××—×•×¨×”</small></div></div>

        <div class="tabs">
          <div class="tab on" onclick="atab('lb')">ğŸ† ×“×™×¨×•×’</div>
          <div class="tab" onclick="atab('monthly')">ğŸ“… ×—×•×“×©×™</div>
          <div class="tab" onclick="atab('season')">ğŸŒ¿ ×¢×•× ×”</div>
          <div class="tab" onclick="atab('location')">ğŸ“ ××™×§×•×</div>
          <div class="tab" onclick="atab('attend')">âœ… × ×•×›×—×•×ª</div>
          <div class="tab" onclick="atab('hist')">ğŸ“‹ ×”×™×¡×˜×•×¨×™×”</div>
        </div>

        <div class="card" style="padding:11px 16px;margin-bottom:14px">
          <div style="display:flex;gap:9px;align-items:center;flex-wrap:wrap">
            <span style="font-size:.79rem;font-weight:700;color:var(--bark)">×ª×§×•×¤×”:</span>
            <select id="ap" onchange="renderA()" style="padding:6px 9px;border:1.5px solid var(--parch);border-radius:7px;font-family:'Heebo',sans-serif;font-size:.82rem;background:white;direction:rtl">
              <option value="week">×©×‘×•×¢ ××—×¨×•×Ÿ</option>
              <option value="month" selected>×—×•×“×© ××—×¨×•×Ÿ</option>
              <option value="season">×¢×•× ×” (3 ×—×•×“×©×™×)</option>
              <option value="year">×©× ×” ×©×œ××”</option>
              <option value="all">×›×œ ×”×–×× ×™×</option>
            </select>
            <span style="font-size:.79rem;font-weight:700;color:var(--bark)">×¢×•×‘×“:</span>
            <select id="aw" onchange="renderA()" style="padding:6px 9px;border:1.5px solid var(--parch);border-radius:7px;font-family:'Heebo',sans-serif;font-size:.82rem;background:white;direction:rtl">
              <option value="">×›×•×œ×</option>
            </select>
          </div>
        </div>

        <div class="g4" style="margin-bottom:18px">
          <div class="sc cv"><div class="sc-ic">ğŸ“‹</div><div><div class="sc-num" id="as-s">0</div><div class="sc-lbl">××©××¨×•×ª</div></div></div>
          <div class="sc cg"><div class="sc-ic">ğŸŒ¿</div><div><div class="sc-num" id="as-t">0</div><div class="sc-lbl">×¢×¦×™×</div></div></div>
          <div class="sc cb"><div class="sc-ic">â­</div><div><div class="sc-num" id="as-a">0</div><div class="sc-lbl">×××•×¦×¢/××©××¨×ª</div></div></div>
          <div class="sc cr"><div class="sc-ic">ğŸ’°</div><div><div class="sc-num" id="as-r">â‚ª0</div><div class="sc-lbl">×”×›× ×¡×•×ª</div></div></div>
        </div>

        <div id="a-lb" class="ap"></div>
        <div id="a-monthly" class="ap" style="display:none"></div>
        <div id="a-season" class="ap" style="display:none"></div>
        <div id="a-location" class="ap" style="display:none"></div>
        <div id="a-attend" class="ap" style="display:none"></div>
        <div id="a-hist" class="ap" style="display:none"></div>
      </div>

      <!-- â•â• MY SHIFTS (worker) â•â• -->
      <div class="pg" id="pg-myshifts">
        <div class="hero">
          <div class="hav">ğŸ‘¤</div>
          <div class="hi"><h2 id="whn">×©×œ×•×!</h2><p id="whs">×”××©××¨×•×ª ×©×œ×š</p></div>
        </div>
        <div id="tmrw-block"></div>
        <div class="card"><div class="ct">ğŸ“‹ ×›×œ ×”××©××¨×•×ª ×©×œ×™</div><div id="mysl"></div></div>
      </div>

      <!-- â•â• MY STATS (worker) â•â• -->
      <div class="pg" id="pg-mystats">
        <div class="ph"><div class="pt">×”×¡×˜×˜×™×¡×˜×™×§×” ×©×œ×™</div></div>
        <div class="g4" style="margin-bottom:20px">
          <div class="sc cv"><div class="sc-ic">ğŸ“‹</div><div><div class="sc-num" id="ms-s">0</div><div class="sc-lbl">××©××¨×•×ª</div></div></div>
          <div class="sc cg"><div class="sc-ic">ğŸŒ¿</div><div><div class="sc-num" id="ms-t">0</div><div class="sc-lbl">×¢×¦×™×</div></div></div>
          <div class="sc cb"><div class="sc-ic">â­</div><div><div class="sc-num" id="ms-a">0</div><div class="sc-lbl">×××•×¦×¢/××©××¨×ª</div></div></div>
          <div class="sc cr"><div class="sc-ic">ğŸ’°</div><div><div class="sc-num" id="ms-r">â‚ª0</div><div class="sc-lbl">×”×›× ×¡×•×ª</div></div></div>
        </div>
        <div class="card">
          <div class="ct">ğŸ“… ×”×™×¡×˜×•×¨×™×” ××™×©×™×ª</div>
          <div class="tw"><table><thead><tr><th>×ª××¨×™×š</th><th>×¡×•×’</th><th>××™×§×•×</th><th>×ª×¤×§×™×“</th><th>ğŸŒ¿ ×¢×¦×™× ×©×œ×™</th><th>â‚ª/×¢×¥</th><th>×”×›× ×¡×”</th></tr></thead>
          <tbody id="ms-tb"></tbody></table></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- MODAL SHIFT -->
<div class="mo" id="mo-s">
  <div class="md" style="max-width:720px">
    <div class="mh"><div class="mttl" id="s-ttl">â• ×¡×™×“×•×¨ ×¢×‘×•×“×” ×—×“×©</div><button class="mcl" onclick="cmo('mo-s')">âœ•</button></div>
    <input type="hidden" id="s-id" />
    <div class="frow">
      <div class="ff"><label>×ª××¨×™×š *</label><input type="date" id="s-dt" /></div>
      <div class="ff"><label>×¡×•×’ ×¢×‘×•×“×”</label>
        <select id="s-tp"><option>×–××™×¨×”</option><option>×§×©×™×¨×”</option><option>×“×™×œ×•×œ</option><option>××™×¡×•×£</option><option>×’×™×–×•×</option><option>××—×¨</option></select>
      </div>
    </div>
    <div class="frow">
      <div class="ff" style="flex:2"><label>ğŸ“ ××™×§×•× / ×©× ×›×¨×</label><input type="text" id="s-loc" placeholder="×œ×“×•×’××”: ×›×¨× ×©×’×‘, ×’×•×© 12" /></div>
    </div>
    <div class="frow">
      <div class="ff"><label>ğŸ—ºï¸ Google Maps</label><input type="url" id="s-gm" placeholder="https://maps.google.com/..." /></div>
      <div class="ff"><label>ğŸ§­ Waze</label><input type="url" id="s-wz" placeholder="https://waze.com/ul?..." /></div>
    </div>
    <div class="ff" style="margin-bottom:11px">
      <label>ğŸ‘· ×©×™×‘×•×¥ ×¢×•×‘×“×™×</label>
      <div class="chips" id="s-wc" style="margin-top:5px"></div>
    </div>
    <div class="frow">
      <div class="ff"><label>â­ ×× ×”×œ ×¢×‘×•×“×”</label><select id="s-mgr"><option value="">-- ×‘×—×¨ --</option></select></div>
      <div class="ff"><label>ğŸš— ×¨×›×‘×™×</label><input type="number" id="s-vh" min="0" max="20" placeholder="0" /></div>
    </div>
    <div class="ff" style="margin-bottom:11px">
      <label>ğŸš— × ×”×’×™×</label>
      <div class="chips" id="s-dc" style="margin-top:5px"><span style="color:var(--stone);font-size:.79rem">×‘×—×¨ ×¢×•×‘×“×™× ×§×•×“×</span></div>
    </div>
    <div class="frow">
      <div class="ff"><label>ğŸ’° ×ª×¢×¨×™×£ ×œ×¢×¥ (â‚ª) *</label><input type="number" id="s-rt" min="0" step="0.1" placeholder="3.50" /></div>
      <div class="ff"><label>ğŸ“ ×”×¢×¨×•×ª</label><input type="text" id="s-nt" placeholder="×”×¢×¨×•×ª..." /></div>
    </div>

    <!-- Per-worker tree entry -->
    <div style="background:var(--light-vine);border:1.5px solid var(--vine);border-radius:10px;padding:13px;margin-top:6px">
      <div style="font-weight:700;font-size:.87rem;color:var(--vine);margin-bottom:9px">
        ğŸŒ¿ ×¢×¦×™× ×œ×¤×™ ×¢×•×‘×“ <span style="font-weight:400;font-size:.79rem;color:var(--stone)">(×××œ××™× ×œ××—×¨ ×‘×™×¦×•×¢ ×”×¢×‘×•×“×”)</span>
      </div>
      <div class="tw">
        <table class="trt">
          <thead><tr><th>×¢×•×‘×“</th><th>×¢×¦×™× ×©×–××¨</th><th>âœ… × ×›×—</th><th>×”×›× ×¡×”</th></tr></thead>
          <tbody id="s-ttb"></tbody>
        </table>
      </div>
      <div class="sumbox" id="s-sumbox" style="display:none">
        ×¡×”×´×› ×¦×•×•×ª: <strong id="s-tot-t">0</strong> ×¢×¦×™× Â· <strong id="s-tot-r">â‚ª0</strong>
      </div>
    </div>

    <div class="mft">
      <button class="btn btn-s" onclick="cmo('mo-s')">×‘×™×˜×•×œ</button>
      <button class="btn btn-p" onclick="saveShift()">ğŸ’¾ ×©××•×¨</button>
    </div>
  </div>
</div>

<!-- MODAL WORKER -->
<div class="mo" id="mo-w">
  <div class="md">
    <div class="mh"><div class="mttl" id="w-ttl">â• ×¢×•×‘×“ ×—×“×©</div><button class="mcl" onclick="cmo('mo-w')">âœ•</button></div>
    <input type="hidden" id="w-id" />
    <div class="frow">
      <div class="ff"><label>×©× ××œ× *</label><input type="text" id="w-nm" placeholder="×©× ×•×©× ××©×¤×—×”" /></div>
      <div class="ff"><label>×©× ××©×ª××© *</label><input type="text" id="w-us" placeholder="loginname" /></div>
    </div>
    <div class="frow">
      <div class="ff"><label>×¡×™×¡××” *</label><input type="password" id="w-pw" /></div>
      <div class="ff"><label>×˜×œ×¤×•×Ÿ</label><input type="tel" id="w-ph" placeholder="05X-XXXXXXX" /></div>
    </div>
    <div class="frow" style="gap:20px;margin-top:4px">
      <div style="display:flex;align-items:center;gap:8px"><label class="tgl"><input type="checkbox" id="w-adm"><span class="tsl"></span></label><span style="font-weight:700;font-size:.88rem">×× ×”×œ ××¢×¨×›×ª</span></div>
      <div style="display:flex;align-items:center;gap:8px"><label class="tgl"><input type="checkbox" id="w-car"><span class="tsl"></span></label><span style="font-weight:700;font-size:.88rem">×™×© ×¨×›×‘</span></div>
    </div>
    <div class="mft">
      <button class="btn btn-s" onclick="cmo('mo-w')">×‘×™×˜×•×œ</button>
      <button class="btn btn-p" onclick="saveWorker()">ğŸ’¾ ×©××•×¨</button>
    </div>
  </div>
</div>

<div class="tst" id="tst"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â• DATA â•â•â•â•â•â•â•â•â•â•â•â• */
function od(d){const x=new Date();x.setDate(x.getDate()+d);return x.toISOString().split('T')[0]}
function td(){return new Date().toISOString().split('T')[0]}
function tmr(){const x=new Date();x.setDate(x.getDate()+1);return x.toISOString().split('T')[0]}

const DEF={
  users:[
    {id:1,name:'×× ×”×œ ×¨××©×™',username:'admin',password:'admin123',isAdmin:true,hasCar:true,phone:''},
    {id:2,name:'×“×•×“ ×›×”×Ÿ',username:'david',password:'1234',isAdmin:false,hasCar:true,phone:'050-1234567'},
    {id:3,name:'××©×” ×œ×•×™',username:'moshe',password:'1234',isAdmin:false,hasCar:false,phone:'052-9876543'},
    {id:4,name:'×™×•×¡×™ ××‘×™×¨×',username:'yossi',password:'1234',isAdmin:false,hasCar:true,phone:'054-1112222'},
    {id:5,name:'××œ×™ ×‘×¨×–×œ×™',username:'eli',password:'1234',isAdmin:false,hasCar:false,phone:'053-5556677'},
  ],
  shifts:[
    {id:1,date:od(1),type:'×–××™×¨×”',location:'×›×¨× ×©×’×‘, ×’×•×© 12',gmaps:'https://maps.google.com',waze:'',workers:[2,3,4,5],manager:2,vehicles:2,drivers:[2,4],rate:3.5,notes:'×œ×”×’×™×¢ ×‘-6:30',wt:{},absent:[]},
    {id:2,date:od(-2),type:'×–××™×¨×”',location:'×›×¨× ×™×©×Ÿ, ×¢×›×•',gmaps:'',waze:'',workers:[2,3,4],manager:2,vehicles:1,drivers:[2],rate:3.5,notes:'',wt:{2:195,3:162,4:218},absent:[]},
    {id:3,date:od(-5),type:'×§×©×™×¨×”',location:'×›×¨× ×©×’×‘, ×’×•×© 12',gmaps:'',waze:'',workers:[3,4,5],manager:4,vehicles:1,drivers:[4],rate:2.8,notes:'',wt:{3:140,4:175,5:130},absent:[]},
    {id:4,date:od(-9),type:'×–××™×¨×”',location:'×›×¨× ×™×©×Ÿ, ×¢×›×•',gmaps:'',waze:'',workers:[2,3,4,5],manager:2,vehicles:2,drivers:[2,4],rate:3.5,notes:'',wt:{2:210,3:178,4:225,5:155},absent:[]},
    {id:5,date:od(-14),type:'×–××™×¨×”',location:'××˜×¢ ×’×“×™×©, × ×”×¨×™×”',gmaps:'',waze:'',workers:[2,4,5],manager:4,vehicles:1,drivers:[4],rate:3.5,notes:'',wt:{2:188,4:205,5:142},absent:[]},
    {id:6,date:od(-21),type:'×’×™×–×•×',location:'×›×¨× ×©×’×‘, ×’×•×© 12',gmaps:'',waze:'',workers:[2,3],manager:2,vehicles:1,drivers:[2],rate:4.0,notes:'',wt:{2:88,3:72},absent:[]},
    {id:7,date:od(-35),type:'×–××™×¨×”',location:'××˜×¢ ×’×“×™×©, × ×”×¨×™×”',gmaps:'',waze:'',workers:[2,3,4,5],manager:2,vehicles:2,drivers:[2,4],rate:3.5,notes:'',wt:{2:200,3:165,4:230,5:148},absent:[]},
    {id:8,date:od(-42),type:'×–××™×¨×”',location:'×›×¨× ×™×©×Ÿ, ×¢×›×•',gmaps:'',waze:'',workers:[2,4],manager:4,vehicles:1,drivers:[4],rate:3.5,notes:'',wt:{2:192,4:215},absent:[]},
    {id:9,date:od(-55),type:'×§×©×™×¨×”',location:'×›×¨× ×©×’×‘, ×’×•×© 12',gmaps:'',waze:'',workers:[3,4,5],manager:4,vehicles:1,drivers:[4],rate:2.8,notes:'',wt:{3:135,4:168,5:125},absent:[]},
    {id:10,date:od(-70),type:'×–××™×¨×”',location:'××˜×¢ ×’×“×™×©, × ×”×¨×™×”',gmaps:'',waze:'',workers:[2,3,4,5],manager:2,vehicles:2,drivers:[2,4],rate:3.2,notes:'',wt:{2:182,3:155,4:210,5:138},absent:[]},
  ],
  nuid:6,nsid:11
};

let DB;
function ldb(){const r=localStorage.getItem('km3');DB=r?JSON.parse(r):JSON.parse(JSON.stringify(DEF))}
function sdb(){localStorage.setItem('km3',JSON.stringify(DB))}
ldb();

/* â•â•â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â• */
let CU=null;
const AVcolors=['#4E7C2A','#B8720A','#1E6FA0','#6A3DB8','#B83025','#2E8B6A'];
function un(id){const u=DB.users.find(x=>x.id===id);return u?u.name:'?'}
function uc(id){const i=DB.users.filter(u=>!u.isAdmin).findIndex(u=>u.id===id);return AVcolors[i%AVcolors.length]}
function fd(d){return new Date(d+'T00:00:00').toLocaleDateString('he-IL',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
function sd(d){return new Date(d+'T00:00:00').toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'2-digit'})}
function mname(d){const dt=new Date(d+'T00:00:00');return`${['×™× ×•','×¤×‘×¨','××¨×¥','××¤×¨','×××™','×™×•× ×™','×™×•×œ×™','××•×’','×¡×¤×˜','××•×§','× ×•×‘','×“×¦×'][dt.getMonth()]} ${String(dt.getFullYear()).slice(2)}`}
function tc(t){return{×–××™×¨×”:'#3D6B1E',×§×©×™×¨×”:'#1E6FA0',×“×™×œ×•×œ:'#B8720A',××™×¡×•×£:'#2E8B6A',×’×™×–×•×:'#6A3DB8',××—×¨:'#888'}[t]||'#888'}
function stt(s){return Object.values(s.wt||{}).reduce((a,v)=>a+Number(v),0)}
function srev(s){return stt(s)*Number(s.rate)}
function wtrees(uid,arr){return arr.reduce((a,s)=>a+Number((s.wt||{})[uid]||0),0)}
function wrev(uid,arr){return arr.reduce((a,s)=>a+Number((s.wt||{})[uid]||0)*Number(s.rate),0)}

function toast(m,t='ok'){const el=document.getElementById('tst');el.textContent=m;el.className='tst '+t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2700)}
function omo(id){document.getElementById(id).classList.add('open')}
function cmo(id){document.getElementById(id).classList.remove('open')}

// vine background
(()=>{let s='';for(let i=0;i<100;i++)s+='ğŸŒ¿ğŸ‡';document.getElementById('vbg').textContent=s})();

/* â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â• */
function login(){
  const u=document.getElementById('lu').value.trim(),p=document.getElementById('lp').value.trim();
  const user=DB.users.find(x=>x.username===u&&x.password===p);
  if(!user){document.getElementById('lerr').style.display='block';return}
  CU=user;document.getElementById('lerr').style.display='none';
  document.getElementById('ls').style.display='none';document.getElementById('app').style.display='block';
  document.getElementById('tu').textContent=user.name;
  if(user.isAdmin){document.getElementById('anv').style.display='block';document.getElementById('wnv').style.display='none';go('dash')}
  else{document.getElementById('anv').style.display='none';document.getElementById('wnv').style.display='block';go('myshifts')}
}
function logout(){CU=null;document.getElementById('ls').style.display='flex';document.getElementById('app').style.display='none';document.getElementById('lu').value='';document.getElementById('lp').value=''}

/* â•â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â•â• */
function go(id){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.nv').forEach(n=>n.classList.remove('on'));
  const pg=document.getElementById('pg-'+id);if(pg)pg.classList.add('on');
  const nv=document.getElementById('n-'+id);if(nv)nv.classList.add('on');
  ({dash:rDash,sched:()=>{document.getElementById('sched-date').value=tmr();renderSched()},
    workers:rWorkers,analytics:()=>{curAtab='lb';renderA()},
    myshifts:rMyShifts,mystats:rMyStats})[id]?.();
}

/* â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â• */
function rDash(){
  document.getElementById('ddate').textContent=fd(td());
  const na=DB.users.filter(u=>!u.isAdmin);
  document.getElementById('d-w').textContent=na.length;
  document.getElementById('d-s').textContent=DB.shifts.length;
  const wa=new Date();wa.setDate(wa.getDate()-7);
  const ws=DB.shifts.filter(s=>new Date(s.date)>=wa&&s.date<=td());
  document.getElementById('d-t').textContent=ws.reduce((a,s)=>a+stt(s),0);
  document.getElementById('d-r').textContent='â‚ª'+ws.reduce((a,s)=>a+srev(s),0).toFixed(0);

  // Tomorrow alert
  const has=DB.shifts.some(s=>s.date===tmr());
  document.getElementById('tmrw-alert').innerHTML=has
    ?'<span class="tmrw-badge">ğŸ“‹ ×™×© ×¡×™×“×•×¨ ××—×¨</span>'
    :'<span style="font-size:.8rem;color:var(--stone)">××™×Ÿ ×¡×™×“×•×¨ ××—×¨ ×¢×“×™×™×Ÿ</span>';

  // Leaderboard
  const lb=na.map(u=>({name:u.name,id:u.id,trees:wtrees(u.id,ws)})).sort((a,b)=>b.trees-a.trees);
  const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  document.getElementById('d-lb').innerHTML=lb.map((r,i)=>`
    <div class="lbrow">
      <div class="lbrank">${medals[i]||`${i+1}.`}</div>
      <div class="lbav" style="background:${uc(r.id)}">${r.name.charAt(0)}</div>
      <div class="lbinfo"><div class="lbname">${r.name}</div><div class="lbsub">${ws.filter(s=>s.workers.includes(r.id)).length} ××©××¨×•×ª</div></div>
      <div class="lbtrees">ğŸŒ¿ ${r.trees}</div>
    </div>`).join('')||'<div class="empty"><div class="emj">ğŸ“Š</div><p>××™×Ÿ × ×ª×•× ×™ ×©×‘×•×¢ ×–×”</p></div>';

  // Upcoming
  const up=DB.shifts.filter(s=>s.date>=td()).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,4);
  document.getElementById('d-up').innerHTML=up.map(s=>`
    <div style="display:flex;align-items:center;gap:9px;padding:8px 0;border-bottom:1px solid var(--parch)">
      <span style="background:${tc(s.type)};color:white;padding:2px 9px;border-radius:14px;font-size:.73rem;font-weight:700;white-space:nowrap">${s.type}</span>
      <div style="flex:1"><div style="font-weight:700;font-size:.85rem">${s.date===td()?'×”×™×•×':s.date===tmr()?'××—×¨':sd(s.date)}</div>
        <div style="font-size:.76rem;color:var(--stone)">${s.location||'â€”'} Â· ${s.workers.length} ×¢×•×‘×“×™×</div>
      </div>
      <button class="btn btn-g btn-xs" onclick="editShift(${s.id});go('sched')">âœï¸</button>
    </div>`).join('')||'<div class="empty"><div class="emj">ğŸ“­</div><p>××™×Ÿ ××©××¨×•×ª ×§×¨×•×‘×•×ª</p></div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â• SCHEDULE â•â•â•â•â•â•â•â•â•â•â•â• */
function schedNav(d){const el=document.getElementById('sched-date');const cur=el.value||td();const dt=new Date(cur+'T00:00:00');dt.setDate(dt.getDate()+d);el.value=dt.toISOString().split('T')[0];renderSched()}

function renderSched(){
  const fdate=document.getElementById('sched-date').value;
  let shifts=[...DB.shifts];
  if(fdate)shifts=shifts.filter(s=>s.date===fdate);
  shifts.sort((a,b)=>a.date.localeCompare(b.date));
  const el=document.getElementById('sl');
  if(!shifts.length){
    const msg=fdate?`×œ× × ××¦× ×¡×™×“×•×¨ ×¢×‘×•×“×” ×œ-${fd(fdate)}`:'×œ× × ××¦××• ×¡×™×“×•×¨×™ ×¢×‘×•×“×”';
    el.innerHTML=`<div class="empty card"><div class="emj">ğŸ“‹</div><p>${msg}</p>${fdate?`<button class="btn btn-p" style="margin-top:12px" onclick="openNewShiftDate('${fdate}')">â• ×¦×•×¨ ×¡×™×“×•×¨ ×œ-${sd(fdate)}</button>`:''}
    </div>`;return;
  }
  el.innerHTML=shifts.map(s=>{
    const past=s.date<td();const tot=stt(s);const rev=srev(s).toFixed(0);
    const wchips=s.workers.map(wid=>{
      const iM=wid===s.manager,iD=s.drivers.includes(wid);
      return`<span class="chip ${iM?'sel':iD?'drv':''}" style="cursor:default">${iM?'â­':iD?'ğŸš—':'ğŸ‘¤'} ${un(wid)}</span>`;
    }).join('');
    const treesHTML=s.workers.map(wid=>{
      const t=Number((s.wt||{})[wid]||0);const r=(t*s.rate).toFixed(0);
      return`<tr><td><div style="display:flex;align-items:center;gap:6px"><div style="width:24px;height:24px;border-radius:50%;background:${uc(wid)};display:flex;align-items:center;justify-content:center;color:white;font-size:.7rem;font-weight:800">${un(wid).charAt(0)}</div>${un(wid)}${wid===s.manager?' â­':''}</div></td>
        <td style="text-align:center;font-weight:700">${t||'â€”'}</td>
        <td style="text-align:center;font-size:.78rem;color:var(--stone)">â‚ª${r}</td>
      </tr>`;
    }).join('');
    return`
    <div class="card" style="border-right:5px solid ${tc(s.type)};padding:0;overflow:hidden">
      <div style="padding:13px 18px;border-bottom:1px solid var(--parch);display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div>
          <div style="font-weight:800;font-size:.98rem">${fd(s.date)}</div>
          <div style="display:flex;gap:6px;margin-top:5px;flex-wrap:wrap">
            <span style="background:${tc(s.type)};color:white;padding:2px 9px;border-radius:14px;font-size:.73rem;font-weight:700">${s.type}</span>
            <span class="bdg ${past?'bk':'bv'}">${past?'×‘×•×¦×¢':'×¢×ª×™×“×™'}</span>
            ${tot?`<span class="bdg bv">ğŸŒ¿ ${tot} ×¢×¦×™×</span>`:''} ${rev>0?`<span class="bdg bg">â‚ª${rev}</span>`:''}
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn btn-g btn-sm" onclick="editShift(${s.id})">âœï¸ ×¢×“×›×Ÿ</button>
          <button class="btn btn-d btn-sm" onclick="delShift(${s.id})">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div style="padding:12px 18px">
        <div class="ir"><span class="lb">ğŸ“ ××™×§×•×:</span><span>${s.location||'â€”'}
          ${s.gmaps?`<a href="${s.gmaps}" target="_blank" class="maplnk" style="margin-right:6px">ğŸ—ºï¸ Google</a>`:''}
          ${s.waze?`<a href="${s.waze}" target="_blank" class="maplnk">ğŸ§­ Waze</a>`:''}
        </span></div>
        <div class="ir"><span class="lb">ğŸ’° ×ª×¢×¨×™×£:</span><span>â‚ª${s.rate} ×œ×¢×¥ Â· ${s.vehicles||0} ×¨×›×‘×™×</span></div>
        ${s.notes?`<div class="ir"><span class="lb">ğŸ“ ×”×¢×¨×•×ª:</span><span style="font-style:italic;color:var(--harvest)">${s.notes}</span></div>`:''}
        <div style="margin-top:9px;font-size:.79rem;font-weight:700;color:var(--stone)">ğŸ‘· ×¦×•×•×ª:</div>
        <div class="chips" style="margin-top:4px">${wchips}</div>
        ${tot?`<div class="sep"></div>
        <div style="font-weight:700;font-size:.82rem;color:var(--vine);margin-bottom:6px">ğŸŒ¿ ×¢×¦×™× ×œ×¤×™ ×¢×•×‘×“</div>
        <div class="tw"><table class="trt"><thead><tr><th>×¢×•×‘×“</th><th>×¢×¦×™×</th><th>×”×›× ×¡×”</th></tr></thead><tbody>${treesHTML}</tbody></table></div>
        <div class="sumbox">×¡×”×´×›: <strong>${tot} ×¢×¦×™×</strong> Â· <strong>â‚ª${rev}</strong></div>`:
        `<div style="margin-top:8px;font-size:.8rem;color:var(--stone);font-style:italic">â³ ×¢×¦×™× ×˜×¨× ×”×•×›× ×¡×• (×¢×ª×™×“×™)</div>`}
      </div>
    </div>`;
  }).join('');
}

/* â”€â”€ Shift modal helpers â”€â”€ */
function selW(){return[...document.querySelectorAll('#s-wc .chip.sel')].map(el=>{const n=el.textContent.trim().replace(/ ğŸš—$/,'');const u=DB.users.find(x=>x.name===n);return u?.id}).filter(Boolean)}
function selD(){return[...document.querySelectorAll('#s-dc .chip.drv')].map(el=>{const n=el.textContent.trim().replace(/ ğŸš—$/,'');const u=DB.users.find(x=>x.name===n);return u?.id}).filter(Boolean)}

function buildWChips(selIds=[]){
  document.getElementById('s-wc').innerHTML=DB.users.filter(u=>u.id!==1).map(u=>`<div class="chip ${selIds.includes(u.id)?'sel':''}" onclick="twChip(this)">${u.name}${u.hasCar?' ğŸš—':''}</div>`).join('');
  rebuildMgr();rebuildDrv();rebuildTT({});
}
function twChip(el){el.classList.toggle('sel');rebuildMgr();rebuildDrv();rebuildTT({})}
function rebuildMgr(){
  const sel=selW();const mg=document.getElementById('s-mgr');const cur=mg.value;
  mg.innerHTML='<option value="">-- ×‘×—×¨ --</option>'+DB.users.filter(u=>sel.includes(u.id)).map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
  if(cur)mg.value=cur;
}
function rebuildDrv(){
  const sel=selW();const dc=document.getElementById('s-dc');
  const wc=DB.users.filter(u=>sel.includes(u.id)&&u.hasCar);
  const prev=[...dc.querySelectorAll('.chip.drv')].map(el=>el.textContent.trim().replace(' ğŸš—',''));
  dc.innerHTML=wc.length?wc.map(u=>`<div class="chip ${prev.includes(u.name)?'drv':''}" onclick="this.classList.toggle('drv')">${u.name} ğŸš—</div>`).join('')
    :'<span style="color:var(--stone);font-size:.79rem">××™×Ÿ ×¢×•×‘×“×™× ×¢× ×¨×›×‘ ×‘×¦×•×•×ª</span>';
}
function rebuildTT(existing){
  const sel=selW();const rate=parseFloat(document.getElementById('s-rt').value)||0;
  document.getElementById('s-ttb').innerHTML=sel.map(id=>{
    const v=existing[id]!==undefined?existing[id]:'';
    return`<tr>
      <td><div style="display:flex;align-items:center;gap:6px"><div style="width:22px;height:22px;border-radius:50%;background:${uc(id)};display:flex;align-items:center;justify-content:center;color:white;font-size:.68rem;font-weight:800">${un(id).charAt(0)}</div>${un(id)}</div></td>
      <td><input type="number" min="0" class="tinp" data-uid="${id}" value="${v}" placeholder="0" oninput="calcSum()" /></td>
      <td><label class="tgl"><input type="checkbox" class="achk" data-uid="${id}" ${v!==''&&v>0?'checked':''}><span class="tsl"></span></label></td>
      <td class="trev" data-uid="${id}" style="font-weight:700;font-size:.82rem;color:var(--vine)">â‚ª${v?((Number(v)*rate).toFixed(0)):'0'}</td>
    </tr>`;
  }).join('');
  calcSum();
}
document.addEventListener('input',e=>{if(e.target.classList.contains('tinp')){const rate=parseFloat(document.getElementById('s-rt').value)||0;const uid=e.target.dataset.uid;const v=Number(e.target.value)||0;const rev=document.querySelector(`.trev[data-uid="${uid}"]`);if(rev)rev.textContent='â‚ª'+(v*rate).toFixed(0);calcSum()}});
function calcSum(){
  const rate=parseFloat(document.getElementById('s-rt').value)||0;
  const tot=[...document.querySelectorAll('.tinp')].reduce((a,i)=>a+Number(i.value||0),0);
  const sb=document.getElementById('s-sumbox');
  if(tot>0){sb.style.display='block';document.getElementById('s-tot-t').textContent=tot;document.getElementById('s-tot-r').textContent='â‚ª'+(tot*rate).toFixed(0)}
  else sb.style.display='none';
}
function getTT(){const d={};[...document.querySelectorAll('.tinp')].forEach(i=>{d[i.dataset.uid]=Number(i.value)||0});return d}

function openNewShift(date=tmr()){
  document.getElementById('s-ttl').textContent='â• ×¡×™×“×•×¨ ×¢×‘×•×“×” ×—×“×©';
  document.getElementById('s-id').value='';
  document.getElementById('s-dt').value=date;
  document.getElementById('s-tp').value='×–××™×¨×”';
  ['s-loc','s-gm','s-wz','s-rt','s-nt'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('s-vh').value='';
  buildWChips([]);omo('mo-s');
}
function openNewShiftDate(d){openNewShift(d)}
function editShift(id){
  const s=DB.shifts.find(x=>x.id===id);if(!s)return;
  document.getElementById('s-ttl').textContent='âœï¸ ×¢×¨×™×›×ª ×¡×™×“×•×¨';
  document.getElementById('s-id').value=id;
  document.getElementById('s-dt').value=s.date;
  document.getElementById('s-tp').value=s.type;
  document.getElementById('s-loc').value=s.location||'';
  document.getElementById('s-gm').value=s.gmaps||'';
  document.getElementById('s-wz').value=s.waze||'';
  document.getElementById('s-rt').value=s.rate||'';
  document.getElementById('s-nt').value=s.notes||'';
  document.getElementById('s-vh').value=s.vehicles||0;
  // Build chips
  document.getElementById('s-wc').innerHTML=DB.users.filter(u=>u.id!==1).map(u=>`<div class="chip ${s.workers.includes(u.id)?'sel':''}" onclick="twChip(this)">${u.name}${u.hasCar?' ğŸš—':''}</div>`).join('');
  setTimeout(()=>{
    rebuildMgr();document.getElementById('s-mgr').value=s.manager||'';
    rebuildDrv();
    document.querySelectorAll('#s-dc .chip').forEach(el=>{const n=el.textContent.trim().replace(' ğŸš—','');const u=DB.users.find(x=>x.name===n);if(u&&s.drivers.includes(u.id))el.classList.add('drv')});
    rebuildTT(s.wt||{});
  },30);
  omo('mo-s');
}
function saveShift(){
  const date=document.getElementById('s-dt').value;if(!date){toast('× × ×œ××œ× ×ª××¨×™×š','er');return}
  const rt=parseFloat(document.getElementById('s-rt').value)||0;if(!rt){toast('× × ×œ×”×›× ×™×¡ ×ª×¢×¨×™×£','er');return}
  const obj={date,type:document.getElementById('s-tp').value,location:document.getElementById('s-loc').value,
    gmaps:document.getElementById('s-gm').value,waze:document.getElementById('s-wz').value,
    workers:selW(),manager:parseInt(document.getElementById('s-mgr').value)||null,
    vehicles:parseInt(document.getElementById('s-vh').value)||0,drivers:selD(),
    rate:rt,notes:document.getElementById('s-nt').value,wt:getTT(),absent:[]};
  const eid=parseInt(document.getElementById('s-id').value);
  if(eid){const i=DB.shifts.findIndex(s=>s.id===eid);DB.shifts[i]={...DB.shifts[i],...obj};toast('âœ… ×”×¡×™×“×•×¨ ×¢×•×“×›×Ÿ')}
  else{obj.id=DB.nsid++;DB.shifts.push(obj);toast('âœ… ×”×¡×™×“×•×¨ × ×©××¨')}
  sdb();cmo('mo-s');renderSched();
}
function delShift(id){if(!confirm('×œ××—×•×§ ××ª ×”×¡×™×“×•×¨?'))return;DB.shifts=DB.shifts.filter(s=>s.id!==id);sdb();renderSched();toast('ğŸ—‘ï¸ × ××—×§','er')}

/* â•â•â•â•â•â•â•â•â•â•â•â• WORKERS â•â•â•â•â•â•â•â•â•â•â•â• */
function rWorkers(){
  const na=DB.users.filter(u=>u.id!==1);
  if(!na.length){document.getElementById('wtb').innerHTML='<tr><td colspan="7" style="text-align:center;padding:22px;color:var(--stone)">××™×Ÿ ×¢×•×‘×“×™×</td></tr>';return}
  document.getElementById('wtb').innerHTML=na.map(u=>{
    const sh=DB.shifts.filter(s=>s.workers.includes(u.id)).length;
    const tr=wtrees(u.id,DB.shifts);
    return`<tr>
      <td><div style="display:flex;align-items:center;gap:8px"><div style="width:30px;height:30px;border-radius:50%;background:${uc(u.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.82rem;flex-shrink:0">${u.name.charAt(0)}</div>
        <div><div style="font-weight:700">${u.name}</div>${u.phone?`<div style="font-size:.72rem;color:var(--stone)">${u.phone}</div>`:''}</div></div></td>
      <td><code style="background:var(--parch);padding:1px 7px;border-radius:5px;font-size:.8rem">${u.username}</code></td>
      <td>${u.isAdmin?'<span class="bdg bg">×× ×”×œ</span>':'<span class="bdg bv">×¢×•×‘×“</span>'}</td>
      <td>${u.hasCar?'ğŸš—':'â€”'}</td>
      <td><span class="bdg bb">${sh}</span></td>
      <td><span class="bdg bv">ğŸŒ¿ ${tr}</span></td>
      <td><div style="display:flex;gap:5px"><button class="btn btn-s btn-sm" onclick="editWorker(${u.id})">âœï¸</button><button class="btn btn-d btn-sm" onclick="delWorker(${u.id})">ğŸ—‘ï¸</button></div></td>
    </tr>`;
  }).join('');
}
function openNewWorker(){
  document.getElementById('w-ttl').textContent='â• ×¢×•×‘×“ ×—×“×©';
  ['w-id','w-nm','w-us','w-pw','w-ph'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('w-adm').checked=false;document.getElementById('w-car').checked=false;
  omo('mo-w');
}
function editWorker(id){
  const u=DB.users.find(x=>x.id===id);if(!u)return;
  document.getElementById('w-ttl').textContent='âœï¸ ×¢×¨×™×›×ª ×¢×•×‘×“';
  document.getElementById('w-id').value=id;document.getElementById('w-nm').value=u.name;
  document.getElementById('w-us').value=u.username;document.getElementById('w-pw').value=u.password;
  document.getElementById('w-ph').value=u.phone||'';
  document.getElementById('w-adm').checked=u.isAdmin;document.getElementById('w-car').checked=u.hasCar;
  omo('mo-w');
}
function saveWorker(){
  const nm=document.getElementById('w-nm').value.trim(),us=document.getElementById('w-us').value.trim(),pw=document.getElementById('w-pw').value.trim();
  if(!nm||!us||!pw){toast('× × ×œ××œ× ×©×, ×©× ××©×ª××© ×•×¡×™×¡××”','er');return}
  const d={name:nm,username:us,password:pw,phone:document.getElementById('w-ph').value,isAdmin:document.getElementById('w-adm').checked,hasCar:document.getElementById('w-car').checked};
  const eid=parseInt(document.getElementById('w-id').value);
  if(eid){const i=DB.users.findIndex(u=>u.id===eid);DB.users[i]={...DB.users[i],...d};toast('âœ… ×¢×•×“×›×Ÿ')}
  else{if(DB.users.find(u=>u.username===us)){toast('×©× ××©×ª××© ×ª×¤×•×¡','er');return}DB.users.push({id:DB.nuid++,...d});toast('âœ… × ×•×¡×£')}
  sdb();cmo('mo-w');rWorkers();
}
function delWorker(id){if(!confirm('×œ××—×•×§ ××ª ×”×¢×•×‘×“?'))return;DB.users=DB.users.filter(u=>u.id!==id);sdb();rWorkers();toast('ğŸ—‘ï¸ × ××—×§','er')}

/* â•â•â•â•â•â•â•â•â•â•â•â• ANALYTICS â•â•â•â•â•â•â•â•â•â•â•â• */
let curAtab='lb';
function atab(t){
  curAtab=t;
  const tabs=['lb','monthly','season','location','attend','hist'];
  document.querySelectorAll('.tabs .tab').forEach((el,i)=>el.classList.toggle('on',tabs[i]===t));
  document.querySelectorAll('.ap').forEach(el=>el.style.display='none');
  document.getElementById('a-'+t).style.display='block';
  renderA();
}

function getPd(){
  const p=document.getElementById('ap').value;const to=td();let from;
  if(p==='week'){const d=new Date();d.setDate(d.getDate()-7);from=d.toISOString().split('T')[0]}
  else if(p==='month'){const d=new Date();d.setMonth(d.getMonth()-1);from=d.toISOString().split('T')[0]}
  else if(p==='season'){const d=new Date();d.setMonth(d.getMonth()-3);from=d.toISOString().split('T')[0]}
  else if(p==='year'){const d=new Date();d.setFullYear(d.getFullYear()-1);from=d.toISOString().split('T')[0]}
  else from='2020-01-01';
  return{from,to};
}

function renderA(){
  // populate worker filter
  const aw=document.getElementById('aw');const cw=aw.value;
  aw.innerHTML='<option value="">×›×•×œ×</option>'+DB.users.filter(u=>!u.isAdmin).map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
  if(cw)aw.value=cw;

  const{from,to}=getPd();const wf=parseInt(aw.value)||null;
  let shifts=DB.shifts.filter(s=>s.date>=from&&s.date<=to);
  if(wf)shifts=shifts.filter(s=>s.workers.includes(wf));

  const tot=shifts.reduce((a,s)=>a+stt(s),0);
  const rev=shifts.reduce((a,s)=>a+srev(s),0);
  const avg=shifts.length?(tot/shifts.length).toFixed(1):0;
  document.getElementById('as-s').textContent=shifts.length;
  document.getElementById('as-t').textContent=tot;
  document.getElementById('as-a').textContent=avg;
  document.getElementById('as-r').textContent='â‚ª'+rev.toFixed(0);

  const na=DB.users.filter(u=>!u.isAdmin);

  /* â”€â”€ LEADERBOARD â”€â”€ */
  if(curAtab==='lb'){
    const lb=na.map(u=>({name:u.name,id:u.id,
      trees:wtrees(u.id,shifts),
      rev:wrev(u.id,shifts),
      sh:shifts.filter(s=>s.workers.includes(u.id)).length
    })).sort((a,b)=>b.trees-a.trees);
    const maxT=Math.max(...lb.map(r=>r.trees),1);
    const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    document.getElementById('a-lb').innerHTML=`
      <div class="g2">
        <div class="card"><div class="ct">ğŸ† ×“×™×¨×•×’ ×¢×¦×™×</div>
          ${lb.map((r,i)=>`<div class="brow">
            <div class="bname">${medals[i]||''} ${r.name}</div>
            <div class="btrk"><div class="bfil" style="width:${(r.trees/maxT*100).toFixed(0)}%;background:${uc(r.id)}">${r.trees>15?r.trees:''}</div></div>
            <div class="bval">${r.trees} ğŸŒ¿</div>
          </div>`).join('')||'<div class="empty"><p>××™×Ÿ × ×ª×•× ×™×</p></div>'}
        </div>
        <div class="card"><div class="ct">ğŸ’° ×”×›× ×¡×•×ª ×œ×¤×™ ×¢×•×‘×“</div>
          ${lb.map((r,i)=>{const maxR=Math.max(...lb.map(x=>x.rev),1);return`<div class="brow">
            <div class="bname">${r.name}</div>
            <div class="btrk"><div class="bfil" style="width:${(r.rev/maxR*100).toFixed(0)}%;background:${uc(r.id)}">${r.rev>200?'â‚ª'+r.rev.toFixed(0):''}</div></div>
            <div class="bval">â‚ª${r.rev.toFixed(0)}</div>
          </div>`}).join('')||'<div class="empty"><p>××™×Ÿ × ×ª×•× ×™×</p></div>'}
        </div>
      </div>
      <div class="card"><div class="ct">ğŸ“Š ×˜×‘×œ×ª ×‘×™×¦×•×¢×™× ××œ××”</div>
        <div class="tw"><table><thead><tr><th>×“×™×¨×•×’</th><th>×¢×•×‘×“</th><th>××©××¨×•×ª</th><th>×¡×”×´×› ×¢×¦×™×</th><th>×××•×¦×¢/××©××¨×ª</th><th>×”×›× ×¡×”</th></tr></thead>
        <tbody>${lb.map((r,i)=>`<tr>
          <td>${medals[i]||i+1}</td>
          <td><div style="display:flex;align-items:center;gap:7px"><div style="width:26px;height:26px;border-radius:50%;background:${uc(r.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.74rem">${r.name.charAt(0)}</div><strong>${r.name}</strong></div></td>
          <td>${r.sh}</td><td><strong>${r.trees}</strong> ğŸŒ¿</td>
          <td>${r.sh?(r.trees/r.sh).toFixed(1):0}</td>
          <td><strong>â‚ª${r.rev.toFixed(0)}</strong></td>
        </tr>`).join('')||'<tr><td colspan="6" style="text-align:center;padding:18px;color:var(--stone)">××™×Ÿ × ×ª×•× ×™×</td></tr>'}</tbody></table></div>
      </div>`;
  }

  /* â”€â”€ MONTHLY â”€â”€ */
  if(curAtab==='monthly'){
    // Last 6 months per worker
    const months=[];const now=new Date();
    for(let i=5;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1);months.push({key:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,lbl:mname(d.toISOString().split('T')[0])})}
    document.getElementById('a-monthly').innerHTML=`<div class="card"><div class="ct">ğŸ“… ×¢×¦×™× ×œ×¤×™ ×¢×•×‘×“ â€“ 6 ×—×•×“×©×™× ××—×¨×•× ×™×</div>
      ${na.map(u=>{
        const mdata=months.map(m=>{
          const msh=DB.shifts.filter(s=>s.date.startsWith(m.key)&&s.workers.includes(u.id));
          return{lbl:m.lbl,trees:wtrees(u.id,msh)};
        });
        const maxM=Math.max(...mdata.map(x=>x.trees),1);
        const totalM=mdata.reduce((a,x)=>a+x.trees,0);
        return`<div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--parch)">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <div style="width:28px;height:28px;border-radius:50%;background:${uc(u.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.8rem">${u.name.charAt(0)}</div>
            <strong style="font-size:.9rem">${u.name}</strong>
            <span class="bdg bv" style="margin-right:auto">ğŸŒ¿ ${totalM} ×¢×¦×™× ×¡×”×´×›</span>
          </div>
          <div class="month-chart">
            ${mdata.map(m=>`<div>
              <div class="mc-bar" style="height:${maxM>0?(m.trees/maxM*100).toFixed(0):0}%;background:${uc(u.id)};opacity:${m.trees>0?1:.25}">
                <span class="mc-tt">${m.lbl}: ${m.trees} ×¢×¦×™×</span>
              </div>
              <div class="mc-lbl">${m.lbl}</div>
            </div>`).join('')}
          </div>
        </div>`;
      }).join('')}
    </div>`;
  }

  /* â”€â”€ SEASON (comparison) â”€â”€ */
  if(curAtab==='season'){
    const maxAll=Math.max(...na.map(u=>wtrees(u.id,shifts)),1);
    document.getElementById('a-season').innerHTML=`
      <div class="card"><div class="ct">ğŸŒ¿ ×”×©×•×•××ª ×¢×•×‘×“×™× ×œ××•×¨×š ×”×¢×•× ×”</div>
        ${na.map(u=>{
          const trees=wtrees(u.id,shifts);const rev=wrev(u.id,shifts);
          const myS=shifts.filter(s=>s.workers.includes(u.id));
          const avg=myS.length?(trees/myS.length).toFixed(1):0;
          return`<div style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
              <div style="display:flex;align-items:center;gap:8px">
                <div style="width:30px;height:30px;border-radius:50%;background:${uc(u.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.8rem">${u.name.charAt(0)}</div>
                <strong>${u.name}</strong>
              </div>
              <div style="display:flex;gap:8px">
                <span class="bdg bv">ğŸŒ¿ ${trees}</span>
                <span class="bdg bg">â­ ${avg}/××©××¨×ª</span>
                <span class="bdg bb">â‚ª${rev.toFixed(0)}</span>
              </div>
            </div>
            <div class="pb"><div class="pf" style="width:${(trees/maxAll*100).toFixed(0)}%;background:${uc(u.id)}"></div></div>
          </div>`;
        }).join('')}
      </div>
      <div class="g2">
        <div class="card"><div class="ct">ğŸ“Š ×¤×™×œ×•×— ×œ×¤×™ ×¡×•×’ ×¢×‘×•×“×”</div>
          ${(()=>{const by={};shifts.forEach(s=>{by[s.type]=by[s.type]||{c:0,t:0};by[s.type].c++;by[s.type].t+=stt(s)});
          const mx=Math.max(...Object.values(by).map(v=>v.t),1);
          return Object.entries(by).sort((a,b)=>b[1].t-a[1].t).map(([t,v])=>`
            <div class="brow"><div class="bname"><span style="background:${tc(t)};color:white;padding:1px 7px;border-radius:12px;font-size:.7rem">${t}</span></div>
            <div class="btrk"><div class="bfil" style="width:${(v.t/mx*100).toFixed(0)}%;background:${tc(t)}">${v.t>0?v.t:''}</div></div>
            <div class="bval">${v.t} ğŸŒ¿</div></div>`).join('')||'<div class="empty"><p>××™×Ÿ × ×ª×•× ×™×</p></div>'})()}
        </div>
        <div class="card"><div class="ct">ğŸ“ˆ ××’××” ×—×•×“×©×™×ª</div>
          ${(()=>{const months=[];const now=new Date();for(let i=5;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1);months.push({key:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,lbl:mname(d.toISOString().split('T')[0])})}
          const md=months.map(m=>{const ms=shifts.filter(s=>s.date.startsWith(m.key));return{lbl:m.lbl,trees:ms.reduce((a,s)=>a+stt(s),0)}});
          const mx2=Math.max(...md.map(x=>x.trees),1);
          return`<div class="month-chart">${md.map(m=>`<div><div class="mc-bar" style="height:${(m.trees/mx2*100).toFixed(0)}%;background:var(--vine);opacity:${m.trees>0?1:.2}"><span class="mc-tt">${m.lbl}: ${m.trees} ×¢×¦×™×</span></div><div class="mc-lbl">${m.lbl}</div></div>`).join('')}</div>`;})()}
        </div>
      </div>`;
  }

  /* â”€â”€ LOCATION â”€â”€ */
  if(curAtab==='location'){
    const by={};shifts.forEach(s=>{const l=s.location||'×œ× ×”×•×’×“×¨';by[l]=by[l]||{c:0,t:0,r:0};by[l].c++;by[l].t+=stt(s);by[l].r+=srev(s)});
    const arr=Object.entries(by).sort((a,b)=>b[1].r-a[1].r);
    const maxR=Math.max(...arr.map(([,v])=>v.r),1);
    document.getElementById('a-location').innerHTML=`
      <div class="card"><div class="ct">ğŸ“ ×”×›× ×¡×•×ª ×œ×¤×™ ××™×§×•× / ×›×¨×</div>
        ${arr.map(([loc,v])=>`
          <div style="margin-bottom:14px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:6px">
              <strong style="font-size:.88rem">${loc}</strong>
              <div style="display:flex;gap:6px"><span class="bdg bv">ğŸŒ¿ ${v.t} ×¢×¦×™×</span><span class="bdg bg">â‚ª${v.r.toFixed(0)}</span><span class="bdg bk">${v.c} ××©××¨×•×ª</span></div>
            </div>
            <div class="pb"><div class="pf" style="width:${(v.r/maxR*100).toFixed(0)}%;background:var(--harvest)"></div></div>
          </div>`).join('')||'<div class="empty"><p>××™×Ÿ × ×ª×•× ×™×</p></div>'}
      </div>`;
  }

  /* â”€â”€ ATTENDANCE â”€â”€ */
  if(curAtab==='attend'){
    document.getElementById('a-attend').innerHTML=`<div class="card"><div class="ct">âœ… × ×•×›×—×•×ª ×•×¢×“×¨×•×™×•×ª</div>
      <div class="tw"><table><thead><tr><th>×¢×•×‘×“</th><th>×©×•×‘×¥</th><th>× ×›×—</th><th>×¢×“×¨×•×ª</th><th>% × ×•×›×—×•×ª</th></tr></thead>
      <tbody>${na.map(u=>{
        const asgn=shifts.filter(s=>s.workers.includes(u.id));
        const present=asgn.filter(s=>Number((s.wt||{})[u.id]||0)>0).length;
        const absent=asgn.length-present;const pct=asgn.length?(present/asgn.length*100).toFixed(0):0;
        const color=pct>=80?'var(--vine)':pct>=50?'var(--harvest)':'var(--red)';
        return`<tr>
          <td><div style="display:flex;align-items:center;gap:7px"><div style="width:26px;height:26px;border-radius:50%;background:${uc(u.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.74rem">${u.name.charAt(0)}</div><strong>${u.name}</strong></div></td>
          <td>${asgn.length}</td>
          <td style="color:var(--vine);font-weight:700">${present}</td>
          <td style="color:var(--red);font-weight:700">${absent}</td>
          <td><div style="display:flex;align-items:center;gap:8px">
            <div class="pb" style="width:80px;margin:0"><div class="pf" style="width:${pct}%;background:${color}"></div></div>
            <span style="font-weight:700;font-size:.83rem;color:${color}">${pct}%</span>
          </div></td>
        </tr>`;
      }).join('')}</tbody></table></div></div>`;
  }

  /* â”€â”€ HISTORY â”€â”€ */
  if(curAtab==='hist'){
    const sorted=[...shifts].sort((a,b)=>b.date.localeCompare(a.date));
    document.getElementById('a-hist').innerHTML=`<div class="card"><div class="ct">ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ××©××¨×•×ª ××œ××”</div>
      <div class="tw"><table><thead><tr><th>×ª××¨×™×š</th><th>×¡×•×’</th><th>××™×§×•×</th><th>×× ×”×œ</th><th>×¢×•×‘×“×™×</th><th>×¢×¦×™×</th><th>â‚ª/×¢×¥</th><th>×¡×”×´×›</th></tr></thead>
      <tbody>${sorted.map(s=>`<tr>
        <td>${sd(s.date)}</td>
        <td><span style="background:${tc(s.type)};color:white;padding:1px 8px;border-radius:12px;font-size:.71rem;font-weight:700">${s.type}</span></td>
        <td style="font-size:.81rem">${s.location||'â€”'}</td>
        <td style="font-size:.81rem">${s.manager?un(s.manager):'â€”'}</td>
        <td style="font-size:.78rem">${s.workers.map(un).join(', ')}</td>
        <td><strong>${stt(s)}</strong></td>
        <td>â‚ª${s.rate}</td>
        <td><strong>â‚ª${srev(s).toFixed(0)}</strong></td>
      </tr>`).join('')||'<tr><td colspan="8" style="text-align:center;padding:18px;color:var(--stone)">××™×Ÿ × ×ª×•× ×™×</td></tr>'}</tbody></table></div>
    </div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â• WORKER VIEWS â•â•â•â•â•â•â•â•â•â•â•â• */
function rMyShifts(){
  if(!CU)return;
  const myS=DB.shifts.filter(s=>s.workers.includes(CU.id));
  document.getElementById('whn').textContent=`×©×œ×•×, ${CU.name}! ğŸ‘‹`;
  document.getElementById('whs').textContent=`${myS.length} ××©××¨×•×ª ×‘×¡×”×´×›`;

  // Tomorrow card
  const ts=DB.shifts.find(s=>s.date===tmr()&&s.workers.includes(CU.id));
  const tbl=document.getElementById('tmrw-block');
  if(ts){
    const iM=ts.manager===CU.id,isD=ts.drivers.includes(CU.id);
    tbl.innerHTML=`<div class="tmrw-card">
      <div style="font-weight:800;font-size:1rem;margin-bottom:10px">ğŸ“… ××©××¨×ª ××—×¨</div>
      <div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px">
        <span style="background:rgba(255,255,255,.25);color:white;padding:3px 12px;border-radius:14px;font-weight:700">${ts.type}</span>
        ${iM?'<span style="background:rgba(255,255,255,.25);color:white;padding:3px 12px;border-radius:14px;font-weight:700">â­ ×× ×”×œ ×¢×‘×•×“×”</span>':''}
        ${isD?'<span style="background:rgba(255,255,255,.25);color:white;padding:3px 12px;border-radius:14px;font-weight:700">ğŸš— ××¡×™×¢</span>':''}
      </div>
      <div class="ir"><span class="lb">ğŸ“ ××™×§×•×:</span><span>${ts.location||'â€”'}
        ${ts.gmaps?`<a href="${ts.gmaps}" target="_blank" class="maplnk" style="margin-right:6px">ğŸ—ºï¸ Google</a>`:''}
        ${ts.waze?`<a href="${ts.waze}" target="_blank" class="maplnk">ğŸ§­ Waze</a>`:''}
      </span></div>
      <div class="ir"><span class="lb">ğŸ‘· ×¦×•×•×ª:</span><span>${ts.workers.map(un).join(', ')}</span></div>
      <div class="ir"><span class="lb">ğŸš— × ×”×’×™×:</span><span>${ts.drivers.map(un).join(', ')||'â€”'}</span></div>
      <div class="ir"><span class="lb">ğŸ’° ×ª×¢×¨×™×£:</span><span>â‚ª${ts.rate} ×œ×¢×¥</span></div>
      ${ts.notes?`<div class="ir"><span class="lb">ğŸ“ ×”×¢×¨×•×ª:</span><span style="font-weight:700">${ts.notes}</span></div>`:''}
    </div>`;
  }else{
    tbl.innerHTML=`<div class="card" style="border-right:5px solid var(--stone);margin-bottom:16px">
      <div class="ct">ğŸ“… ××©××¨×ª ××—×¨</div>
      <div class="empty" style="padding:20px"><div class="emj">âœ…</div><p>××™×Ÿ ××©××¨×ª ××—×¨ â€“ × ×”× ×” ××”×× ×•×—×”!</p></div>
    </div>`;
  }

  const sorted=[...myS].sort((a,b)=>b.date.localeCompare(a.date));
  document.getElementById('mysl').innerHTML=sorted.map(s=>{
    const past=s.date<td();const iM=s.manager===CU.id;const mt=Number((s.wt||{})[CU.id]||0);
    return`<div class="wsc" style="border-right-color:${tc(s.type)}">
      <div class="wsch">
        <strong style="font-size:.88rem">${sd(s.date)} â€” ${s.type}</strong>
        <div style="display:flex;gap:5px">
          ${iM?'<span class="bdg bg">â­</span>':''}
          ${s.date===tmr()?'<span class="bdg bo">××—×¨</span>':past?'<span class="bdg bk">×¢×‘×¨</span>':'<span class="bdg bv">×§×¨×•×‘</span>'}
        </div>
      </div>
      <div class="wscb">
        <div class="ir"><span class="lb">ğŸ“</span><span>${s.location||'â€”'}
          ${s.gmaps?`<a href="${s.gmaps}" target="_blank" class="maplnk" style="margin-right:5px">ğŸ—ºï¸</a>`:''}
          ${s.waze?`<a href="${s.waze}" target="_blank" class="maplnk">ğŸ§­</a>`:''}
        </span></div>
        ${mt?`<div class="ir"><span class="lb">ğŸŒ¿ ×¢×¦×™×:</span><span><strong>${mt}</strong> Â· â‚ª${(mt*s.rate).toFixed(0)}</span></div>`:''}
      </div>
    </div>`;
  }).join('')||'<div class="empty"><div class="emj">ğŸ“­</div><p>×¢×“×™×™×Ÿ ×œ× ×©×•×‘×¦×ª</p></div>';
}

function rMyStats(){
  if(!CU)return;
  const myS=DB.shifts.filter(s=>s.workers.includes(CU.id)&&s.date<=td());
  const trees=wtrees(CU.id,myS);
  const rev=wrev(CU.id,myS);
  const avg=myS.length?(trees/myS.length).toFixed(1):0;
  document.getElementById('ms-s').textContent=myS.length;
  document.getElementById('ms-t').textContent=trees;
  document.getElementById('ms-a').textContent=avg;
  document.getElementById('ms-r').textContent='â‚ª'+rev.toFixed(0);
  document.getElementById('ms-tb').innerHTML=[...myS].sort((a,b)=>b.date.localeCompare(a.date)).map(s=>{
    const t=Number((s.wt||{})[CU.id]||0);
    return`<tr>
      <td>${sd(s.date)}</td>
      <td><span style="background:${tc(s.type)};color:white;padding:1px 7px;border-radius:11px;font-size:.71rem;font-weight:700">${s.type}</span></td>
      <td style="font-size:.81rem">${s.location||'â€”'}</td>
      <td>${s.manager===CU.id?'<span class="bdg bg">â­ ×× ×”×œ</span>':'<span class="bdg bv">×¢×•×‘×“</span>'}</td>
      <td><strong>${t}</strong> ğŸŒ¿</td><td>â‚ª${s.rate}</td>
      <td style="font-weight:700">â‚ª${(t*s.rate).toFixed(0)}</td>
    </tr>`;
  }).join('')||'<tr><td colspan="7" style="text-align:center;padding:16px;color:var(--stone)">××™×Ÿ × ×ª×•× ×™×</td></tr>';
}
</script>
</body>
</html>
