<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×›×¨× ×× ×’×³×¨</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --E:#170E04;--B:#3E2006;--V:#3A6618;--L:#5A9428;
  --LV:#EBF3DC;--H:#A86808;--G:#D4A02A;
  --C:#F5EDE0;--P:#E5D5BA;--S:#8A7060;--M:#F7F3EC;
  --R:#A82820;--U:#1868A0;--PU:#5830A8;--TL:#0E8060;
  --sh:rgba(23,14,4,.09);--ds:rgba(23,14,4,.20)
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Heebo',sans-serif;background:var(--M);color:var(--E);min-height:100vh;direction:rtl}

/* LOGIN */
#LS{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 20% 60%,#285010 0%,#170E04 60%,#0a0702 100%);position:relative;overflow:hidden}
.VB{position:absolute;inset:0;font-size:5rem;opacity:.06;line-height:1.1;overflow:hidden;pointer-events:none;display:flex;flex-wrap:wrap}
.LC{background:var(--C);border-radius:22px;padding:44px 36px;width:400px;max-width:94vw;
  box-shadow:0 28px 72px rgba(0,0,0,.55);position:relative;z-index:1;animation:UP .5s ease}
@keyframes UP{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.LL{text-align:center;margin-bottom:26px}
.LL .EM{font-size:3.4rem;display:block;margin-bottom:3px}
.LL h1{font-size:1.85rem;font-weight:900;color:var(--B)}
.LL p{font-size:.8rem;color:var(--S);margin-top:2px}
.FG{margin-bottom:13px}.FG label{display:block;font-weight:700;font-size:.79rem;color:var(--B);margin-bottom:4px}
.FG input{width:100%;padding:10px 13px;border:2px solid var(--P);border-radius:9px;
  font-family:'Heebo',sans-serif;font-size:.9rem;background:white;color:var(--E);direction:rtl;transition:border-color .2s}
.FG input:focus{outline:none;border-color:var(--V)}
.ER{background:#fdecea;border:1px solid #f5c6cb;color:var(--R);padding:8px 12px;border-radius:7px;font-size:.81rem;margin-top:9px;display:none}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 17px;border:none;border-radius:8px;
  font-family:'Heebo',sans-serif;font-size:.83rem;font-weight:700;cursor:pointer;transition:all .16s}
.btn-F{width:100%;justify-content:center;font-size:.94rem;padding:12px}
.bP{background:var(--V);color:white}.bP:hover{background:#2a4e10;transform:translateY(-1px)}
.bS{background:var(--P);color:var(--E)}.bS:hover{background:#d0bea0}
.bD{background:var(--R);color:white}.bD:hover{background:#851e15}
.bG{background:var(--H);color:white}.bG:hover{background:#7e4e04}
.bB{background:var(--U);color:white}.bB:hover{background:#104e78}
.bT{background:var(--TL);color:white}.bT:hover{background:#065040}
.bSm{padding:5px 11px;font-size:.76rem}.bXs{padding:3px 8px;font-size:.71rem;border-radius:6px}

/* APP */
#APP{display:none;min-height:100vh}
.TOP{background:linear-gradient(90deg,var(--E),var(--B));color:white;padding:0 20px;height:56px;
  display:flex;align-items:center;justify-content:space-between;box-shadow:0 3px 12px var(--ds);position:sticky;top:0;z-index:200}
.BRD{display:flex;align-items:center;gap:8px;font-size:1.1rem;font-weight:900}
.TR{display:flex;align-items:center;gap:11px;font-size:.8rem}.TR strong{color:var(--G)}
.TOP-NOTIF{background:var(--R);color:white;border-radius:50%;width:18px;height:18px;font-size:.65rem;font-weight:800;display:flex;align-items:center;justify-content:center;margin-right:-6px;margin-top:-10px}

.LAY{display:flex;min-height:calc(100vh - 56px)}
.SB{width:196px;background:var(--C);border-left:1px solid var(--P);padding:12px 0;flex-shrink:0;box-shadow:2px 0 5px var(--sh)}
.SL{padding:4px 15px 2px;font-size:.65rem;font-weight:800;color:var(--S);text-transform:uppercase;letter-spacing:1.2px}
.NV{display:flex;align-items:center;gap:8px;padding:9px 15px;cursor:pointer;font-weight:500;font-size:.83rem;
  color:var(--B);transition:all .14s;border-right:3px solid transparent;position:relative}
.NV:hover{background:var(--P);color:var(--E)}
.NV.ON{background:linear-gradient(90deg,rgba(58,102,24,.15),transparent);color:var(--V);border-right-color:var(--V);font-weight:700}
.NI{font-size:.98rem;width:18px;text-align:center}
.NV-BADGE{background:var(--R);color:white;border-radius:10px;padding:1px 6px;font-size:.65rem;font-weight:800;margin-right:auto}
.CNT{flex:1;padding:22px;overflow-y:auto;background:var(--M)}

/* PAGES */
.PG{display:none;animation:FI .2s ease}
.PG.ON{display:block}
@keyframes FI{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.PH{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:9px}
.PT{font-size:1.45rem;font-weight:900;color:var(--E)}
.PT small{display:block;font-size:.77rem;font-weight:400;color:var(--S);margin-top:1px}

/* CARDS */
.card{background:white;border-radius:12px;box-shadow:0 2px 9px var(--sh);padding:18px;margin-bottom:14px}
.CT{font-size:.9rem;font-weight:700;color:var(--E);margin-bottom:11px;border-bottom:2px solid var(--P);padding-bottom:8px;display:flex;align-items:center;gap:6px}

/* GRID */
.G2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.G3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:13px}
.G4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}

/* STAT CARDS */
.SC{background:white;border-radius:12px;box-shadow:0 2px 9px var(--sh);padding:15px 17px;
  display:flex;align-items:center;gap:12px;transition:transform .18s;border-right:4px solid}
.SC:hover{transform:translateY(-2px)}
.SI{font-size:1.8rem}.SN{font-size:1.65rem;font-weight:900;line-height:1}.SK{font-size:.73rem;color:var(--S);margin-top:2px}
.sv{border-right-color:var(--V)}.sh{border-right-color:var(--H)}.sb{border-right-color:var(--U)}
.sr{border-right-color:var(--R)}.st{border-right-color:var(--TL)}

/* TABLE */
.TW{overflow-x:auto;border-radius:8px;border:1px solid var(--P)}
table{width:100%;border-collapse:collapse;font-size:.82rem}
thead th{background:var(--C);padding:9px 12px;font-weight:700;color:var(--B);text-align:right;border-bottom:2px solid var(--P);white-space:nowrap}
tbody td{padding:8px 12px;border-bottom:1px solid #ede0cc;color:var(--E)}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover{background:var(--M)}

/* BADGE */
.BD{display:inline-block;padding:2px 8px;border-radius:16px;font-size:.7rem;font-weight:700}
.bv{background:var(--LV);color:var(--V)}.bg2{background:#fff3cd;color:#6a4c00}
.bb{background:#d0e8f5;color:#0a4562}.br{background:#fde8e6;color:#6e1010}
.bk{background:#e2e3e5;color:#3a3a3a}.bo{background:#ffe5c8;color:#6a3000}
.bp{background:#ecdcff;color:#3d1878}.bt{background:#d0f0e8;color:#065040}

/* FORM */
.FR{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;margin-bottom:11px}
.FF{display:flex;flex-direction:column;gap:3px;flex:1;min-width:115px}
.FF label{font-size:.76rem;font-weight:700;color:var(--B)}
.FF input,.FF select,.FF textarea{padding:7px 10px;border:1.5px solid var(--P);border-radius:7px;
  font-family:'Heebo',sans-serif;font-size:.82rem;background:white;color:var(--E);direction:rtl;transition:border-color .2s}
.FF input:focus,.FF select:focus,.FF textarea:focus{outline:none;border-color:var(--V)}
.FF textarea{resize:vertical;min-height:52px}

/* CHIPS */
.CPS{display:flex;flex-wrap:wrap;gap:5px}
.CP{display:flex;align-items:center;gap:4px;padding:4px 10px;border:1.5px solid var(--P);border-radius:16px;
  cursor:pointer;font-size:.78rem;font-weight:600;color:var(--E);transition:all .13s;background:white;user-select:none}
.CP.sel{background:var(--V);color:white;border-color:var(--V)}
.CP.drv{background:var(--U);color:white;border-color:var(--U)}

/* MODAL */
.MO{position:fixed;inset:0;background:rgba(23,14,4,.62);display:none;align-items:center;justify-content:center;z-index:1000;padding:13px}
.MO.open{display:flex;animation:FI .18s ease}
.MD{background:white;border-radius:16px;padding:24px 26px;width:100%;max-width:680px;max-height:92vh;overflow-y:auto;box-shadow:0 16px 52px rgba(0,0,0,.32)}
.MH{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.MTL{font-size:1.1rem;font-weight:800;color:var(--E)}
.MCL{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--S);padding:2px 6px;border-radius:5px}
.MCL:hover{background:var(--P)}
.MFT{display:flex;gap:7px;justify-content:flex-end;margin-top:16px;padding-top:13px;border-top:1px solid var(--P)}

/* TOGGLE */
.TGL{position:relative;width:40px;height:20px;flex-shrink:0}
.TGL input{opacity:0;width:0;height:0}
.TSL{position:absolute;inset:0;background:var(--S);border-radius:20px;cursor:pointer;transition:background .2s}
.TSL:before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:white;border-radius:50%;transition:transform .2s}
.TGL input:checked+.TSL{background:var(--V)}
.TGL input:checked+.TSL:before{transform:translateX(20px)}

/* TOAST */
.TST{position:fixed;bottom:18px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--E);
  color:white;padding:9px 19px;border-radius:9px;font-weight:700;font-size:.83rem;z-index:9999;
  box-shadow:0 4px 18px rgba(0,0,0,.28);transition:transform .28s}
.TST.show{transform:translateX(-50%) translateY(0)}
.TST.ok{background:var(--V)}.TST.er{background:var(--R)}

/* BARS */
.BR{display:flex;align-items:center;gap:7px;margin-bottom:8px}
.BN{width:90px;font-size:.78rem;font-weight:600;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.BT{flex:1;height:19px;background:var(--P);border-radius:4px;overflow:hidden}
.BF{height:100%;border-radius:4px;display:flex;align-items:center;padding-right:6px;font-size:.7rem;font-weight:700;color:white;transition:width .55s;min-width:2px}
.BV{font-size:.77rem;font-weight:700;color:var(--B);width:52px;text-align:left;flex-shrink:0}

/* PROGRESS */
.PB{height:7px;background:var(--P);border-radius:4px;overflow:hidden;margin-top:3px}
.PF{height:100%;border-radius:4px;transition:width .5s}

/* TABS */
.TBS{display:flex;gap:3px;background:var(--P);border-radius:8px;padding:3px;margin-bottom:14px;width:fit-content;flex-wrap:wrap}
.TB{padding:6px 13px;border-radius:6px;cursor:pointer;font-weight:600;font-size:.79rem;color:var(--B);transition:all .15s}
.TB.ON{background:white;color:var(--V);box-shadow:0 2px 6px var(--sh)}

/* MINI CHART */
.MCH{display:flex;align-items:flex-end;gap:3px;height:70px;padding:2px 0}
.MCH-B{flex:1;border-radius:3px 3px 0 0;position:relative;transition:opacity .2s;min-width:10px;cursor:default}
.MCH-B:hover .TT{display:block}
.TT{display:none;position:absolute;bottom:105%;left:50%;transform:translateX(-50%);background:var(--E);
  color:white;padding:3px 7px;border-radius:5px;font-size:.68rem;white-space:nowrap;z-index:10;pointer-events:none}
.MCH-L{font-size:.62rem;text-align:center;color:var(--S);margin-top:2px}

/* WORKER SHIFT CARDS */
.WSC{background:white;border-radius:11px;box-shadow:0 2px 9px var(--sh);margin-bottom:10px;overflow:hidden;border-right:4px solid}
.WSH{padding:10px 14px;color:white;display:flex;align-items:center;justify-content:space-between}
.WSB{padding:11px 14px}
.IR{display:flex;gap:7px;align-items:flex-start;margin-bottom:5px;font-size:.82rem}
.IR .LB{color:var(--S);font-weight:600;width:76px;flex-shrink:0}
.ML{display:inline-flex;align-items:center;gap:3px;color:var(--U);font-size:.74rem;font-weight:700;
  text-decoration:none;background:#d8ecf8;padding:2px 8px;border-radius:13px;transition:background .17s}
.ML:hover{background:#b5d8f0}

/* TREE TABLE */
.TTR td,.TTR th{padding:6px 9px;font-size:.8rem}
.TTR input[type=number]{width:70px;padding:4px 7px;border:1.5px solid var(--P);border-radius:5px;
  font-family:'Heebo',sans-serif;font-size:.8rem;text-align:center;background:white}
.TTR input[type=number]:focus{outline:none;border-color:var(--V)}

/* WORKER HOME */
.WHERO{border-radius:16px;overflow:hidden;margin-bottom:16px;box-shadow:0 4px 20px var(--ds)}
.TODAY-CARD{background:linear-gradient(135deg,var(--V),#1e3d0a);border-radius:14px;padding:22px;color:white;margin-bottom:0;box-shadow:0 6px 24px rgba(58,102,24,.35)}
.TMR-CARD{background:linear-gradient(135deg,var(--H),#6a4000);border-radius:14px;padding:22px;color:white;margin-bottom:0;box-shadow:0 6px 24px rgba(168,104,8,.35)}
.TODAY-CARD .IR .LB,.TMR-CARD .IR .LB{color:rgba(255,255,255,.72)}
.TODAY-CARD a.ML,.TMR-CARD a.ML{background:rgba(255,255,255,.2);color:white}
.BIG-TREE{text-align:center;padding:18px 0}
.BIG-NUM{font-size:4.5rem;font-weight:900;line-height:1}
.BIG-LBL{font-size:.85rem;margin-top:5px;opacity:.85}
.BIG-REV{font-size:1.3rem;font-weight:800;margin-top:4px}

.LBR{display:flex;align-items:center;gap:9px;padding:9px 0;border-bottom:1px solid var(--P)}
.LBR:last-child{border-bottom:none}
.LBR-RK{font-size:1.3rem;width:28px;text-align:center;flex-shrink:0}
.LBR-AV{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.82rem;color:white;flex-shrink:0}
.LBR-IN{flex:1}.LBR-NM{font-weight:700;font-size:.85rem}.LBR-SB{font-size:.72rem;color:var(--S)}
.LBR-TR{font-size:1.05rem;font-weight:900;color:var(--V)}
.LBR.ME{background:var(--LV);border-radius:9px;padding:9px 10px;border:1.5px solid var(--V)}
.MR{display:flex;align-items:center;gap:9px;padding:9px 0;border-bottom:1px solid var(--P)}
.MR:last-child{border-bottom:none}
.MR-MO{width:60px;font-size:.79rem;font-weight:700;color:var(--B);flex-shrink:0}
.MR-BAR{flex:1}
.MR-VAL{font-size:.81rem;font-weight:700;color:var(--V);width:65px;text-align:left;flex-shrink:0}

.SEP{border:none;border-top:1.5px solid var(--P);margin:12px 0}
.SUMBOX{background:var(--LV);border:1.5px solid var(--V);border-radius:9px;padding:10px 13px;margin-top:11px;font-size:.83rem}
.SUMBOX strong{color:var(--V)}
.EMPTY{text-align:center;padding:34px 14px;color:var(--S)}
.EMJ{font-size:2.2rem;margin-bottom:7px}

/* STATUS PILL */
.pill-active{background:#d4edda;color:#155724;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:700;display:inline-block}
.pill-inactive{background:#f8d7da;color:#721c24;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:700;display:inline-block}

/* SHIFT STATUS PILLS */
.ss-full{background:#d4edda;color:#155724;padding:2px 10px;border-radius:14px;font-size:.73rem;font-weight:700}
.ss-partial{background:#fff3cd;color:#856404;padding:2px 10px;border-radius:14px;font-size:.73rem;font-weight:700}
.ss-cancelled{background:#f8d7da;color:#721c24;padding:2px 10px;border-radius:14px;font-size:.73rem;font-weight:700}
.ss-pending{background:#e2e3e5;color:#383d41;padding:2px 10px;border-radius:14px;font-size:.73rem;font-weight:700}

/* LEAVE REQUEST */
.leave-req{border:1.5px solid var(--P);border-radius:10px;padding:12px 14px;margin-bottom:9px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.leave-req.pending{border-color:#ffc107}
.leave-req.approved{border-color:var(--V);background:var(--LV)}
.leave-req.rejected{border-color:var(--R);background:#fde8e6}

/* CAR PASSENGERS TABLE */
.car-table{width:100%;border-collapse:collapse;font-size:.81rem;margin-top:8px}
.car-table th{background:var(--C);padding:7px 10px;font-weight:700;color:var(--B);text-align:right;border-bottom:1.5px solid var(--P)}
.car-table td{padding:6px 10px;border-bottom:1px solid #ede0cc}
.car-table tr:last-child td{border-bottom:none}

/* INLINE EDIT */
.inline-input{padding:4px 8px;border:1.5px solid var(--P);border-radius:6px;font-family:'Heebo',sans-serif;font-size:.82rem;width:72px;text-align:center}
.inline-input:focus{outline:none;border-color:var(--V)}

@media(max-width:768px){
  .SB{width:46px}.SB .NV span:not(.NI){display:none}.SL{display:none}
  .G4{grid-template-columns:1fr 1fr}.G3{grid-template-columns:1fr}.G2{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="LS">
  <div class="VB" id="VB"></div>
  <div class="LC">
    <div class="LL"><span class="EM">ğŸ‡</span><h1>×›×¨× ×× ×’×³×¨</h1><p>××¢×¨×›×ª × ×™×”×•×œ ×–××™×¨×ª ×’×¤× ×™×</p></div>
    <div class="FG"><label>×©× ××©×ª××©</label><input id="LU" type="text" placeholder="×©× ××©×ª××©" /></div>
    <div class="FG"><label>×¡×™×¡××”</label><input id="LP" type="password" placeholder="×¡×™×¡××”" onkeydown="if(event.key==='Enter')login()" /></div>
    <button class="btn bP btn-F" style="margin-top:8px" onclick="login()">ğŸ” ×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
    <div class="ER" id="ER">×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×</div>
  </div>
</div>

<!-- APP -->
<div id="APP">
  <div class="TOP">
    <div class="BRD">ğŸ‡ <span>×›×¨× ×× ×’×³×¨</span></div>
    <div class="TR">×©×œ×•×, <strong id="TU">-</strong>
      <div id="TOP-NOTIF-WRAP" style="position:relative;display:none">
        <button class="btn bS bSm" onclick="go('leave')">ğŸ–ï¸ ×‘×§×©×•×ª ×—×•×¤×© <span id="TOP-NOTIF-NUM" class="TOP-NOTIF">0</span></button>
      </div>
      <button class="btn bS bSm" onclick="logout()">×™×¦×™××”</button>
    </div>
  </div>
  <div class="LAY">
    <div class="SB">
      <!-- Admin nav -->
      <div id="ANV">
        <div style="height:7px"></div>
        <div class="SL">× ×™×”×•×œ</div>
        <div class="NV ON" onclick="go('dash')" id="n-dash"><span class="NI">ğŸ“Š</span><span>×“×©×‘×•×¨×“</span></div>
        <div class="NV" onclick="go('sched')" id="n-sched"><span class="NI">ğŸ“‹</span><span>×¡×™×“×•×¨ ×¢×‘×•×“×”</span></div>
        <div class="NV" onclick="go('workers')" id="n-workers"><span class="NI">ğŸ‘·</span><span>×¢×•×‘×“×™×</span></div>
        <div class="NV" onclick="go('leave')" id="n-leave"><span class="NI">ğŸ–ï¸</span><span>×‘×§×©×•×ª ×—×•×¤×©</span><span class="NV-BADGE" id="LEAVE-BADGE" style="display:none">0</span></div>
        <div class="NV" onclick="go('analytics')" id="n-analytics"><span class="NI">ğŸ“ˆ</span><span>× ×™×ª×•×— × ×ª×•× ×™×</span></div>
      </div>
      <!-- Worker nav -->
      <div id="WNV" style="display:none">
        <div style="height:7px"></div>
        <div class="SL">××™×©×™</div>
        <div class="NV ON" onclick="go('home')" id="n-home"><span class="NI">ğŸŒ¿</span><span>×”×“×£ ×©×œ×™</span></div>
        <div class="NV" onclick="go('myshifts')" id="n-myshifts"><span class="NI">ğŸ“…</span><span>×”××©××¨×•×ª ×©×œ×™</span></div>
        <div class="NV" onclick="go('myleave')" id="n-myleave"><span class="NI">ğŸ–ï¸</span><span>×‘×§×©×•×ª ×—×•×¤×©</span></div>
      </div>
    </div>
    <div class="CNT">

      <!-- DASHBOARD -->
      <div class="PG ON" id="pg-dash">
        <div class="PH">
          <div class="PT">×“×©×‘×•×¨×“ <small id="DDATE"></small></div>
          <div id="D-TMRW"></div>
        </div>
        <div class="G4" style="margin-bottom:18px">
          <div class="SC sv"><div class="SI">ğŸ‘·</div><div><div class="SN" id="d-w">0</div><div class="SK">×¢×•×‘×“×™× ×¤×¢×™×œ×™×</div></div></div>
          <div class="SC sh"><div class="SI">ğŸ“‹</div><div><div class="SN" id="d-s">0</div><div class="SK">×¡×”×´×› ××©××¨×•×ª</div></div></div>
          <div class="SC sb"><div class="SI">ğŸŒ¿</div><div><div class="SN" id="d-t">0</div><div class="SK">×¢×¦×™× ×”×©×‘×•×¢</div></div></div>
          <div class="SC sr"><div class="SI">ğŸ’°</div><div><div class="SN" id="d-r">â‚ª0</div><div class="SK">×”×›× ×¡×•×ª ×”×©×‘×•×¢</div></div></div>
        </div>
        <div class="G2">
          <div class="card"><div class="CT">ğŸ† ×“×™×¨×•×’ ×¢×¦×™× â€“ ×”×©×‘×•×¢</div><div id="D-LB"></div></div>
          <div class="card"><div class="CT">ğŸ“‹ ××©××¨×•×ª ×§×¨×•×‘×•×ª</div><div id="D-UP"></div></div>
        </div>
      </div>

      <!-- SCHEDULE -->
      <div class="PG" id="pg-sched">
        <div class="PH">
          <div class="PT">×¡×™×“×•×¨ ×¢×‘×•×“×” <small>× ×™×”×•×œ ×™×•××™</small></div>
          <button class="btn bP" onclick="openNewShift()">â• ×¡×™×“×•×¨ ×—×“×©</button>
        </div>
        <div class="card" style="padding:11px 15px;margin-bottom:13px">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <button class="btn bS bSm" onclick="sNav(-1)">â—€ ×™×•× ×§×•×“×</button>
            <input type="date" id="SD" style="padding:6px 9px;border:1.5px solid var(--P);border-radius:7px;font-family:'Heebo',sans-serif;font-size:.85rem;background:white;color:var(--E);direction:rtl" oninput="rSched()" />
            <button class="btn bS bSm" onclick="sNav(1)">×™×•× ×”×‘× â–¶</button>
            <button class="btn bS bSm" onclick="document.getElementById('SD').value=td();rSched()">×”×™×•×</button>
            <button class="btn bG bSm" onclick="document.getElementById('SD').value=tmr();rSched()">ğŸ“… ××—×¨</button>
            <button class="btn bS bSm" onclick="document.getElementById('SD').value='';rSched()">×”×›×œ</button>
          </div>
        </div>
        <div id="SL"></div>
      </div>

      <!-- WORKERS -->
      <div class="PG" id="pg-workers">
        <div class="PH">
          <div class="PT">×¢×•×‘×“×™× <small>× ×™×”×•×œ ××©×ª××©×™×</small></div>
          <button class="btn bP" onclick="openNewWorker()">â• ×¢×•×‘×“ ×—×“×©</button>
        </div>
        <div class="card">
          <div class="TW"><table>
            <thead><tr><th>×©×</th><th>×©× ××©×ª××©</th><th>×ª×¤×§×™×“</th><th>×¨×›×‘</th><th>×¡×˜×˜×•×¡</th><th>××©××¨×•×ª</th><th>×¢×¦×™×</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
            <tbody id="WTB"></tbody>
          </table></div>
        </div>
      </div>

      <!-- LEAVE REQUESTS (admin) -->
      <div class="PG" id="pg-leave">
        <div class="PH"><div class="PT">×‘×§×©×•×ª ×—×•×¤×© <small>××™×©×•×¨ ×•×“×—×™×™×”</small></div></div>
        <div class="card"><div class="CT">â³ ×‘×§×©×•×ª ×××ª×™× ×•×ª ×œ××™×©×•×¨</div><div id="LEAVE-PENDING"></div></div>
        <div class="card"><div class="CT">ğŸ“‹ ×›×œ ×”×‘×§×©×•×ª</div><div id="LEAVE-ALL"></div></div>
      </div>

      <!-- ANALYTICS -->
      <div class="PG" id="pg-analytics">
        <div class="PH"><div class="PT">× ×™×ª×•×— × ×ª×•× ×™× <small>×¡×˜×˜×™×¡×˜×™×§×” ××œ××”</small></div></div>
        <div class="TBS" id="ATBS">
          <div class="TB ON" onclick="atab('lb')">ğŸ† ×“×™×¨×•×’</div>
          <div class="TB" onclick="atab('monthly')">ğŸ“… ×—×•×“×©×™</div>
          <div class="TB" onclick="atab('season')">ğŸŒ¿ ×¢×•× ×”</div>
          <div class="TB" onclick="atab('location')">ğŸ“ ××™×§×•×</div>
          <div class="TB" onclick="atab('attend')">âœ… × ×•×›×—×•×ª</div>
          <div class="TB" onclick="atab('hist')">ğŸ“‹ ×”×™×¡×˜×•×¨×™×”</div>
        </div>
        <div class="card" style="padding:10px 14px;margin-bottom:13px">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span style="font-size:.77rem;font-weight:700;color:var(--B)">×ª×§×•×¤×”:</span>
            <select id="AP" onchange="rA()" style="padding:5px 9px;border:1.5px solid var(--P);border-radius:7px;font-family:'Heebo',sans-serif;font-size:.8rem;background:white;direction:rtl">
              <option value="week">×©×‘×•×¢</option><option value="month" selected>×—×•×“×©</option>
              <option value="season">×¢×•× ×”</option><option value="year">×©× ×”</option><option value="all">×”×›×œ</option>
            </select>
            <span style="font-size:.77rem;font-weight:700;color:var(--B)">×¢×•×‘×“:</span>
            <select id="AW" onchange="rA()" style="padding:5px 9px;border:1.5px solid var(--P);border-radius:7px;font-family:'Heebo',sans-serif;font-size:.8rem;background:white;direction:rtl"><option value="">×›×•×œ×</option></select>
          </div>
        </div>
        <div class="G4" style="margin-bottom:16px">
          <div class="SC sv"><div class="SI">ğŸ“‹</div><div><div class="SN" id="as-s">0</div><div class="SK">××©××¨×•×ª</div></div></div>
          <div class="SC sh"><div class="SI">ğŸŒ¿</div><div><div class="SN" id="as-t">0</div><div class="SK">×¢×¦×™×</div></div></div>
          <div class="SC sb"><div class="SI">â­</div><div><div class="SN" id="as-a">0</div><div class="SK">×××•×¦×¢/××©××¨×ª</div></div></div>
          <div class="SC sr"><div class="SI">ğŸ’°</div><div><div class="SN" id="as-r">â‚ª0</div><div class="SK">×”×›× ×¡×•×ª</div></div></div>
        </div>
        <div id="a-lb" class="AP-PANEL"></div>
        <div id="a-monthly" class="AP-PANEL" style="display:none"></div>
        <div id="a-season" class="AP-PANEL" style="display:none"></div>
        <div id="a-location" class="AP-PANEL" style="display:none"></div>
        <div id="a-attend" class="AP-PANEL" style="display:none"></div>
        <div id="a-hist" class="AP-PANEL" style="display:none"></div>
      </div>

      <!-- WORKER HOME -->
      <div class="PG" id="pg-home">
        <div class="WHERO">
          <div style="background:linear-gradient(135deg,var(--V),var(--E));padding:20px 22px;color:white">
            <div style="display:flex;align-items:center;gap:14px">
              <div id="W-AV" style="width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.5rem;color:white;border:3px solid rgba(255,255,255,.4);flex-shrink:0"></div>
              <div><div id="W-NAME" style="font-size:1.25rem;font-weight:900"></div><div id="W-SUB" style="font-size:.78rem;opacity:.82;margin-top:2px"></div></div>
              <div style="margin-right:auto" id="W-RANK-BADGE"></div>
            </div>
          </div>
        </div>
        <div class="G2" id="W-DAYROW" style="margin-bottom:14px"></div>
        <div class="card"><div class="CT">ğŸ“… ×¡×™×›×•× ×—×•×“×©×™ â€“ ×”×¢×•× ×”</div><div id="W-MONTHLY"></div></div>
        <div class="card"><div class="CT">ğŸ† ×“×™×¨×•×’ ×¢×•×‘×“×™× â€“ ×”×¢×•× ×”</div><div id="W-LB"></div></div>
      </div>

      <!-- MY SHIFTS -->
      <div class="PG" id="pg-myshifts">
        <div class="PH"><div class="PT">×”××©××¨×•×ª ×©×œ×™</div></div>
        <div class="G4" style="margin-bottom:16px">
          <div class="SC sv"><div class="SI">ğŸ“‹</div><div><div class="SN" id="ms-s">0</div><div class="SK">××©××¨×•×ª</div></div></div>
          <div class="SC sh"><div class="SI">ğŸŒ¿</div><div><div class="SN" id="ms-t">0</div><div class="SK">×¢×¦×™×</div></div></div>
          <div class="SC sb"><div class="SI">â­</div><div><div class="SN" id="ms-a">0</div><div class="SK">×××•×¦×¢/××©××¨×ª</div></div></div>
          <div class="SC sr"><div class="SI">ğŸ’°</div><div><div class="SN" id="ms-r">â‚ª0</div><div class="SK">×”×›× ×¡×•×ª</div></div></div>
        </div>
        <div id="MS-LIST"></div>
      </div>

      <!-- MY LEAVE REQUESTS -->
      <div class="PG" id="pg-myleave">
        <div class="PH">
          <div class="PT">×‘×§×©×•×ª ×—×•×¤×© <small>×©×œ×—×• ×‘×§×©×” ×œ×—×•×¤×©</small></div>
          <button class="btn bP" onclick="openLeaveReq()">â• ×‘×§×©×ª ×—×•×¤×© ×—×“×©×”</button>
        </div>
        <div id="MY-LEAVE-LIST"></div>
      </div>

    </div>
  </div>
</div>

<!-- MODAL SHIFT -->
<div class="MO" id="MOS">
  <div class="MD" style="max-width:740px">
    <div class="MH"><div class="MTL" id="S-TTL">â• ×¡×™×“×•×¨ ×—×“×©</div><button class="MCL" onclick="cmo('MOS')">âœ•</button></div>
    <input type="hidden" id="S-ID" />
    <div class="FR">
      <div class="FF"><label>×ª××¨×™×š *</label><input type="date" id="S-DT" /></div>
      <div class="FF"><label>×¡×•×’ ×¢×‘×•×“×”</label>
        <select id="S-TP"><option>×–××™×¨×”</option><option>×§×©×™×¨×”</option><option>×“×™×œ×•×œ</option><option>××™×¡×•×£</option><option>×’×™×–×•×</option><option>××—×¨</option></select>
      </div>
      <div class="FF"><label>ğŸ“Š ×¡×˜×˜×•×¡ ×‘×™×¦×•×¢</label>
        <select id="S-ST">
          <option value="pending">â³ ×˜×¨× ×‘×•×¦×¢</option>
          <option value="full">âœ… ×‘×•×¦×¢ ×‘××œ×•××•</option>
          <option value="partial">âš ï¸ ×‘×•×¦×¢ ×—×œ×§×™×ª</option>
          <option value="cancelled">âŒ ×‘×•×˜×œ</option>
        </select>
      </div>
    </div>
    <div class="FR">
      <div class="FF" style="flex:2"><label>ğŸ“ ××™×§×•× / ×©× ×›×¨×</label><input type="text" id="S-LOC" placeholder="×œ×“×•×’××”: ×›×¨× ×©×’×‘, ×’×•×© 12" /></div>
    </div>
    <div class="FR">
      <div class="FF"><label>ğŸ—ºï¸ Google Maps</label><input type="url" id="S-GM" placeholder="https://maps.google.com/..." /></div>
      <div class="FF"><label>ğŸ§­ Waze</label><input type="url" id="S-WZ" placeholder="https://waze.com/ul?..." /></div>
    </div>
    <div class="FF" style="margin-bottom:10px"><label>ğŸ‘· ×©×™×‘×•×¥ ×¢×•×‘×“×™× (×¤×¢×™×œ×™× ×‘×œ×‘×“)</label><div class="CPS" id="S-WC" style="margin-top:5px"></div></div>
    <div class="FR">
      <div class="FF"><label>â­ ×× ×”×œ ×¢×‘×•×“×”</label><select id="S-MGR"><option value="">-- ×‘×—×¨ --</option></select></div>
      <div class="FF"><label>ğŸ• ×©×¢×ª ×”×ª×—×œ×”</label><input type="time" id="S-TS" /></div>
      <div class="FF"><label>ğŸ• ×©×¢×ª ×¡×™×•×</label><input type="time" id="S-TE" /></div>
    </div>

    <!-- CARS SECTION -->
    <div style="background:#f0f4ff;border:1.5px solid #b8c8e8;border-radius:10px;padding:13px;margin-bottom:11px">
      <div style="font-weight:700;font-size:.85rem;color:var(--U);margin-bottom:9px">ğŸš— × ×™×”×•×œ ×¨×›×‘×™× ×•× ×¡×™×¢×•×ª</div>
      <div class="FR" style="margin-bottom:8px">
        <div class="FF"><label>××¡×¤×¨ ×¨×›×‘×™×</label><input type="number" id="S-VH" min="0" max="20" placeholder="0" oninput="rebuildCars()" /></div>
        <div class="FF"><label>ğŸ“ ×§×´× ×œ× ×¡×™×¢×”</label><input type="number" id="S-KM" min="0" step="1" placeholder="0" oninput="calcCarRate()" /></div>
        <div class="FF"><label>ğŸ’° â‚ª ×œ×§×´×</label><input type="number" id="S-KMR" min="0" step="0.1" placeholder="0" oninput="calcCarRate()" /></div>
        <div class="FF"><label>ğŸ’° ×ª×¢×¨×™×£ ×œ× ×”×’ (â‚ª) <span style="font-size:.68rem;color:var(--S)">××—×•×©×‘ ××•×˜×•×³</span></label><input type="number" id="S-CR" min="0" step="0.5" placeholder="0" style="background:#f0f4ff" /></div>
      </div>
      <div id="S-CARS-WRAP"></div>
    </div>

    <div class="FR">
      <div class="FF"><label>ğŸ’° ×ª×¢×¨×™×£ ×œ×¢×¥ (â‚ª) *</label><input type="number" id="S-RT" min="0" step="0.1" placeholder="3.50" oninput="calcS()" /></div>
      <div class="FF"><label>ğŸ“ ×”×¢×¨×•×ª</label><input type="text" id="S-NT" placeholder="×”×¢×¨×•×ª..." /></div>
    </div>

    <!-- Per-worker trees -->
    <div style="background:var(--LV);border:1.5px solid var(--V);border-radius:10px;padding:12px;margin-top:5px">
      <div style="font-weight:700;font-size:.84rem;color:var(--V);margin-bottom:8px">ğŸŒ¿ ×¢×¦×™× ×•×©×¢×•×ª ×œ×¤×™ ×¢×•×‘×“ <span style="font-weight:400;font-size:.77rem;color:var(--S)">(×××œ××™× ×œ××—×¨ ×”×‘×™×¦×•×¢)</span></div>
      <div class="TW"><table class="TTR">
        <thead><tr><th>×¢×•×‘×“</th><th>×¢×¦×™×</th><th>×©×¢×•×ª</th><th>âœ… × ×›×—</th><th>×”×›× ×¡×” ×¢×¦×™×</th></tr></thead>
        <tbody id="S-TTB"></tbody>
      </table></div>
      <div class="SUMBOX" id="S-SUM" style="display:none">×¡×”×´×› ×¢×¦×™×: <strong id="S-TOTT">0</strong> Â· <strong id="S-TOTR">â‚ª0</strong></div>
    </div>
    <div class="MFT">
      <button class="btn bS" onclick="cmo('MOS')">×‘×™×˜×•×œ</button>
      <button class="btn bP" onclick="saveShift()">ğŸ’¾ ×©××•×¨</button>
    </div>
  </div>
</div>

<!-- MODAL WORKER -->
<div class="MO" id="MOW">
  <div class="MD">
    <div class="MH"><div class="MTL" id="W-TTL">â• ×¢×•×‘×“ ×—×“×©</div><button class="MCL" onclick="cmo('MOW')">âœ•</button></div>
    <input type="hidden" id="W-ID" />
    <div class="FR">
      <div class="FF"><label>×©× ××œ× *</label><input type="text" id="W-NM" /></div>
      <div class="FF"><label>×©× ××©×ª××© *</label><input type="text" id="W-US" placeholder="loginname" /></div>
    </div>
    <div class="FR">
      <div class="FF"><label>×¡×™×¡××” *</label><input type="password" id="W-PW" /></div>
      <div class="FF"><label>×˜×œ×¤×•×Ÿ</label><input type="tel" id="W-PH" placeholder="05X-XXXXXXX" /></div>
    </div>
    <div class="FR" style="gap:18px;margin-top:4px">
      <div style="display:flex;align-items:center;gap:8px"><label class="TGL"><input type="checkbox" id="W-ADM"><span class="TSL"></span></label><span style="font-weight:700;font-size:.86rem">×× ×”×œ ××¢×¨×›×ª</span></div>
      <div style="display:flex;align-items:center;gap:8px"><label class="TGL"><input type="checkbox" id="W-CAR"><span class="TSL"></span></label><span style="font-weight:700;font-size:.86rem">×™×© ×¨×›×‘</span></div>
      <div style="display:flex;align-items:center;gap:8px"><label class="TGL"><input type="checkbox" id="W-ACT" checked><span class="TSL"></span></label><span style="font-weight:700;font-size:.86rem">×¤×¢×™×œ</span></div>
    </div>
    <div class="MFT"><button class="btn bS" onclick="cmo('MOW')">×‘×™×˜×•×œ</button><button class="btn bP" onclick="saveWorker()">ğŸ’¾ ×©××•×¨</button></div>
  </div>
</div>

<!-- MODAL WORKER TREE SELF-REPORT -->
<div class="MO" id="MO-SELF">
  <div class="MD" style="max-width:400px">
    <div class="MH"><div class="MTL">ğŸŒ¿ ×¢×“×›×•×Ÿ ×¢×¦×™× ×•×©×¢×•×ª</div><button class="MCL" onclick="cmo('MO-SELF')">âœ•</button></div>
    <input type="hidden" id="SELF-SID" />
    <p style="font-size:.84rem;color:var(--S);margin-bottom:14px" id="SELF-DESC"></p>
    <div class="FR">
      <div class="FF"><label>ğŸŒ¿ ×›××” ×¢×¦×™× ×–××¨×ª?</label><input type="number" id="SELF-TR" min="0" placeholder="0" /></div>
      <div class="FF"><label>ğŸ• ×©×¢×•×ª ×¢×‘×•×“×”</label><input type="number" id="SELF-HR" min="0" step="0.5" placeholder="0" /></div>
    </div>
    <div class="MFT"><button class="btn bS" onclick="cmo('MO-SELF')">×‘×™×˜×•×œ</button><button class="btn bP" onclick="saveSelf()">ğŸ’¾ ×©××•×¨</button></div>
  </div>
</div>

<!-- MODAL LEAVE REQUEST -->
<div class="MO" id="MO-LV">
  <div class="MD" style="max-width:420px">
    <div class="MH"><div class="MTL">ğŸ–ï¸ ×‘×§×©×ª ×—×•×¤×©</div><button class="MCL" onclick="cmo('MO-LV')">âœ•</button></div>
    <div class="FR">
      <div class="FF"><label>×ª××¨×™×š ×-</label><input type="date" id="LV-FROM" /></div>
      <div class="FF"><label>×¢×“-</label><input type="date" id="LV-TO" /></div>
    </div>
    <div class="FF" style="margin-bottom:12px"><label>ğŸ“ ×¡×™×‘×” (××•×¤×¦×™×•× ×œ×™)</label><textarea id="LV-NOTE" placeholder="×¡×™×‘×ª ×”×‘×§×©×”..."></textarea></div>
    <div class="MFT"><button class="btn bS" onclick="cmo('MO-LV')">×‘×™×˜×•×œ</button><button class="btn bP" onclick="submitLeave()">ğŸ“¤ ×©×œ×— ×‘×§×©×”</button></div>
  </div>
</div>

<div class="TST" id="TST"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â• DATE HELPERS â•â•â•â•â•â•â•â•â•â• */
function od(d){const x=new Date();x.setDate(x.getDate()+d);return x.toISOString().split('T')[0]}
function td(){return new Date().toISOString().split('T')[0]}
function tmr(){const x=new Date();x.setDate(x.getDate()+1);return x.toISOString().split('T')[0]}
function fd(d){return new Date(d+'T00:00:00').toLocaleDateString('he-IL',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
function sd(d){return new Date(d+'T00:00:00').toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'2-digit'})}
function mn(d){const dt=new Date(d+'T00:00:00');return['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'][dt.getMonth()]+' '+dt.getFullYear()}
function mnS(d){return['×™× ×•','×¤×‘×¨','××¨×¥','××¤×¨','×××™','×™×•× ×™','×™×•×œ×™','××•×’','×¡×¤×˜','××•×§','× ×•×‘','×“×¦×'][new Date(d+'T00:00:00').getMonth()]}
function mkey(d){const dt=new Date(d+'T00:00:00');return`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`}

/* â•â•â•â•â•â•â•â•â•â• DATABASE â•â•â•â•â•â•â•â•â•â• */
const DEF={
  users:[
    {id:1,name:'×× ×”×œ ×¨××©×™',username:'admin',password:'admin123',isAdmin:true,hasCar:true,phone:'',active:true},
    {id:2,name:'×“×•×“ ×›×”×Ÿ',username:'david',password:'1234',isAdmin:false,hasCar:true,phone:'050-1234567',active:true},
    {id:3,name:'××©×” ×œ×•×™',username:'moshe',password:'1234',isAdmin:false,hasCar:false,phone:'052-9876543',active:true},
    {id:4,name:'×™×•×¡×™ ××‘×™×¨×',username:'yossi',password:'1234',isAdmin:false,hasCar:true,phone:'054-1112222',active:true},
    {id:5,name:'××œ×™ ×‘×¨×–×œ×™',username:'eli',password:'1234',isAdmin:false,hasCar:false,phone:'053-5556677',active:true},
  ],
  shifts:[
    {id:1,date:od(1),type:'×–××™×¨×”',status:'pending',location:'×›×¨× ×©×’×‘, ×’×•×© 12',gmaps:'https://maps.google.com',waze:'https://waze.com',
     workers:[2,3,4,5],manager:2,vehicles:2,carRate:52,carKm:26,carKmRate:2,cars:[{driver:2,passengers:[3]},{driver:4,passengers:[5]}],
     timeStart:'06:30',timeEnd:'',rate:3.5,notes:'×œ×”×’×™×¢ ×‘-6:30',wt:{},hours:{}},
    {id:2,date:od(0),type:'×–××™×¨×”',status:'full',location:'××˜×¢ ×’×“×™×©, × ×”×¨×™×”',gmaps:'',waze:'',
     workers:[2,4,5],manager:4,vehicles:1,carRate:70,carKm:35,carKmRate:2,cars:[{driver:4,passengers:[2,5]}],
     timeStart:'06:30',timeEnd:'14:00',rate:3.5,notes:'',wt:{2:188,4:205,5:142},hours:{2:7.5,4:7.5,5:7.5}},
    {id:3,date:od(-2),type:'×§×©×™×¨×”',status:'partial',location:'×›×¨× ×™×©×Ÿ, ×¢×›×•',gmaps:'',waze:'',
     workers:[2,3,4],manager:2,vehicles:1,carRate:60,carKm:30,carKmRate:2,cars:[{driver:2,passengers:[3,4]}],
     timeStart:'07:00',timeEnd:'12:00',rate:2.8,notes:'×‘×•×˜×œ ×‘×××¦×¢ ×‘×’×œ×œ ×’×©×',wt:{3:162,4:218},hours:{3:5,4:5}},
    {id:4,date:od(-5),type:'×–××™×¨×”',status:'full',location:'×›×¨× ×©×’×‘, ×’×•×© 12',gmaps:'',waze:'',
     workers:[3,4,5],manager:4,vehicles:1,carRate:52,carKm:26,carKmRate:2,cars:[{driver:4,passengers:[3,5]}],
     timeStart:'06:30',timeEnd:'14:30',rate:3.5,notes:'',wt:{3:158,4:211,5:145},hours:{3:8,4:8,5:8}},
    {id:5,date:od(-9),type:'×–××™×¨×”',status:'full',location:'×›×¨× ×™×©×Ÿ, ×¢×›×•',gmaps:'',waze:'',
     workers:[2,3,4,5],manager:2,vehicles:2,carRate:60,carKm:30,carKmRate:2,cars:[{driver:2,passengers:[3]},{driver:4,passengers:[5]}],
     timeStart:'06:30',timeEnd:'15:00',rate:3.5,notes:'',wt:{2:210,3:178,4:225,5:155},hours:{2:8.5,3:8.5,4:8.5,5:8.5}},
    {id:6,date:od(-14),type:'×–××™×¨×”',status:'full',location:'××˜×¢ ×’×“×™×©, × ×”×¨×™×”',gmaps:'',waze:'',
     workers:[2,4,5],manager:4,vehicles:1,carRate:70,carKm:35,carKmRate:2,cars:[{driver:4,passengers:[2,5]}],
     timeStart:'06:30',timeEnd:'14:00',rate:3.5,notes:'',wt:{2:188,4:205,5:142},hours:{2:7.5,4:7.5,5:7.5}},
    {id:7,date:od(-22),type:'×’×™×–×•×',status:'full',location:'×›×¨× ×©×’×‘, ×’×•×© 12',gmaps:'',waze:'',
     workers:[2,3],manager:2,vehicles:1,carRate:52,carKm:26,carKmRate:2,cars:[{driver:2,passengers:[3]}],
     timeStart:'07:00',timeEnd:'13:00',rate:4.0,notes:'',wt:{2:88,3:72},hours:{2:6,3:6}},
    {id:8,date:od(-30),type:'×–××™×¨×”',status:'full',location:'×›×¨× ×™×©×Ÿ, ×¢×›×•',gmaps:'',waze:'',
     workers:[2,3,4,5],manager:2,vehicles:2,carRate:60,carKm:30,carKmRate:2,cars:[{driver:2,passengers:[3]},{driver:4,passengers:[5]}],
     timeStart:'06:30',timeEnd:'15:00',rate:3.5,notes:'',wt:{2:200,3:165,4:230,5:148},hours:{2:8.5,3:8.5,4:8.5,5:8.5}},
    {id:9,date:od(-38),type:'×–××™×¨×”',status:'cancelled',location:'×›×¨× ×©×’×‘, ×’×•×© 12',gmaps:'',waze:'',
     workers:[2,4],manager:2,vehicles:1,carRate:52,carKm:26,carKmRate:2,cars:[{driver:2,passengers:[4]}],
     timeStart:'06:30',timeEnd:'',rate:3.5,notes:'×‘×•×˜×œ â€“ ×‘×¨×“',wt:{},hours:{}},
    {id:10,date:od(-52),type:'×§×©×™×¨×”',status:'full',location:'×›×¨× ×©×’×‘, ×’×•×© 12',gmaps:'',waze:'',
     workers:[3,4,5],manager:4,vehicles:1,carRate:52,carKm:26,carKmRate:2,cars:[{driver:4,passengers:[3,5]}],
     timeStart:'07:00',timeEnd:'13:30',rate:2.8,notes:'',wt:{3:135,4:168,5:125},hours:{3:6.5,4:6.5,5:6.5}},
  ],
  leaveRequests:[
    {id:1,uid:3,from:od(3),to:od(5),note:'×—×ª×•× ×” ××©×¤×—×ª×™×ª',status:'pending',createdAt:od(0)},
  ],
  nuid:6,nsid:11,nlid:2
};

let DB;
function ldb(){const r=localStorage.getItem('km5');DB=r?JSON.parse(r):JSON.parse(JSON.stringify(DEF))}
function sdb(){localStorage.setItem('km5',JSON.stringify(DB))}
ldb();

/* â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â• */
let CU=null;
const AVC=['#3A6618','#A86808','#1868A0','#5830A8','#A02818','#1E8060','#804818'];
function un(id){return(DB.users.find(x=>x.id===id)||{name:'?'}).name}
function uc(id){const i=DB.users.filter(u=>!u.isAdmin).findIndex(u=>u.id===id);return AVC[i%AVC.length]}
function tc(t){return{×–××™×¨×”:'#3A6618',×§×©×™×¨×”:'#1868A0',×“×™×œ×•×œ:'#A86808',××™×¡×•×£:'#1E8060',×’×™×–×•×:'#5830A8',××—×¨:'#666'}[t]||'#666'}
function stt(s){return Object.values(s.wt||{}).reduce((a,v)=>a+Number(v),0)}
function srev(s){return stt(s)*Number(s.rate)}
function wtr(uid,arr){return arr.reduce((a,s)=>a+Number((s.wt||{})[uid]||0),0)}
function wrv(uid,arr){return arr.reduce((a,s)=>{const trees=Number((s.wt||{})[uid]||0)*Number(s.rate);const carPay=(isDriver(uid,s)&&(s.status==='full'||s.status==='partial'))?Number(s.carRate||0):0;return a+trees+carPay},0)}
function isDriver(uid,s){return(s.cars||[]).some(c=>c.driver===uid)}
function wHours(uid,arr){return arr.reduce((a,s)=>a+Number((s.hours||{})[uid]||0),0)}
function activeWorkers(){return DB.users.filter(u=>u.active!==false&&!u.isAdmin)}
function workerOnLeave(uid,date){return DB.leaveRequests.some(r=>r.uid===uid&&r.status==='approved'&&date>=r.from&&date<=r.to)}

function toast(m,t='ok'){const el=document.getElementById('TST');el.textContent=m;el.className='TST '+t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2700)}
function omo(id){document.getElementById(id).classList.add('open')}
function cmo(id){document.getElementById(id).classList.remove('open')}

(()=>{let s='';for(let i=0;i<120;i++)s+='ğŸŒ¿ğŸ‡';document.getElementById('VB').textContent=s})();

function updateLeaveBadge(){
  const n=DB.leaveRequests.filter(r=>r.status==='pending').length;
  document.getElementById('LEAVE-BADGE').style.display=n?'inline-block':'none';
  document.getElementById('LEAVE-BADGE').textContent=n;
  document.getElementById('TOP-NOTIF-WRAP').style.display=n&&CU?.isAdmin?'block':'none';
  document.getElementById('TOP-NOTIF-NUM').textContent=n;
}

/* â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â• */
function login(){
  const u=document.getElementById('LU').value.trim(),p=document.getElementById('LP').value.trim();
  const usr=DB.users.find(x=>x.username===u&&x.password===p);
  if(!usr){document.getElementById('ER').style.display='block';return}
  CU=usr;document.getElementById('ER').style.display='none';
  document.getElementById('LS').style.display='none';document.getElementById('APP').style.display='block';
  document.getElementById('TU').textContent=usr.name;
  if(usr.isAdmin){
    document.getElementById('ANV').style.display='block';document.getElementById('WNV').style.display='none';
    updateLeaveBadge();go('dash');
  }else{
    document.getElementById('ANV').style.display='none';document.getElementById('WNV').style.display='block';go('home');
  }
}
function logout(){CU=null;document.getElementById('LS').style.display='flex';document.getElementById('APP').style.display='none';document.getElementById('LU').value='';document.getElementById('LP').value=''}

/* â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â• */
function go(id){
  document.querySelectorAll('.PG').forEach(p=>p.classList.remove('ON'));
  document.querySelectorAll('.NV').forEach(n=>n.classList.remove('ON'));
  const pg=document.getElementById('pg-'+id);if(pg)pg.classList.add('ON');
  const nv=document.getElementById('n-'+id);if(nv)nv.classList.add('ON');
  if(id==='dash')rDash();
  if(id==='sched'){if(!document.getElementById('SD').value)document.getElementById('SD').value=tmr();rSched();}
  if(id==='workers')rWorkers();
  if(id==='leave')rLeave();
  if(id==='analytics'){curAt='lb';rA();}
  if(id==='home')rHome();
  if(id==='myshifts')rMyShifts();
  if(id==='myleave')rMyLeave();
}

/* â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â• */
function rDash(){
  document.getElementById('DDATE').textContent=fd(td());
  document.getElementById('d-w').textContent=activeWorkers().length;
  document.getElementById('d-s').textContent=DB.shifts.length;
  const wa=new Date();wa.setDate(wa.getDate()-7);
  const ws=DB.shifts.filter(s=>new Date(s.date)>=wa&&s.date<=td());
  document.getElementById('d-t').textContent=ws.reduce((a,s)=>a+stt(s),0);
  document.getElementById('d-r').textContent='â‚ª'+ws.reduce((a,s)=>a+srev(s),0).toFixed(0);
  const hasTmr=DB.shifts.some(s=>s.date===tmr());
  document.getElementById('D-TMRW').innerHTML=hasTmr?'<span class="BD bg2">ğŸ“… ×™×© ×¡×™×“×•×¨ ××—×¨</span>':'<span style="font-size:.78rem;color:var(--S)">××™×Ÿ ×¡×™×“×•×¨ ××—×¨ ×¢×“×™×™×Ÿ</span>';
  const na=activeWorkers();
  const lb=na.map(u=>({name:u.name,id:u.id,trees:wtr(u.id,ws),sh:ws.filter(s=>s.workers.includes(u.id)).length})).sort((a,b)=>b.trees-a.trees);
  const M=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  document.getElementById('D-LB').innerHTML=lb.map((r,i)=>`
    <div class="LBR"><div class="LBR-RK">${M[i]||`${i+1}.`}</div>
      <div class="LBR-AV" style="background:${uc(r.id)}">${r.name.charAt(0)}</div>
      <div class="LBR-IN"><div class="LBR-NM">${r.name}</div><div class="LBR-SB">${r.sh} ××©××¨×•×ª</div></div>
      <div class="LBR-TR">ğŸŒ¿ ${r.trees}</div></div>`).join('')||'<div class="EMPTY"><p>××™×Ÿ × ×ª×•× ×™×</p></div>';
  const up=DB.shifts.filter(s=>s.date>=td()).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,5);
  document.getElementById('D-UP').innerHTML=up.map(s=>`
    <div style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--P)">
      <span style="background:${tc(s.type)};color:white;padding:1px 9px;border-radius:13px;font-size:.71rem;font-weight:700;white-space:nowrap">${s.type}</span>
      <div style="flex:1"><div style="font-weight:700;font-size:.83rem">${s.date===td()?'×”×™×•×':s.date===tmr()?'××—×¨':sd(s.date)}</div>
        <div style="font-size:.73rem;color:var(--S)">${s.location||'â€”'} Â· ${s.workers.length} ×¢×•×‘×“×™×</div></div>
      ${ssBadge(s.status)}
    </div>`).join('')||'<div class="EMPTY"><div class="EMJ">ğŸ“­</div><p>××™×Ÿ ××©××¨×•×ª ×§×¨×•×‘×•×ª</p></div>';
}

function ssBadge(st){const m={full:'<span class="ss-full">âœ… ×‘×•×¦×¢</span>',partial:'<span class="ss-partial">âš ï¸ ×—×œ×§×™</span>',cancelled:'<span class="ss-cancelled">âŒ ×‘×•×˜×œ</span>',pending:'<span class="ss-pending">â³ ×˜×¨×</span>'};return m[st]||''}

/* â•â•â•â•â•â•â•â•â•â• SCHEDULE â•â•â•â•â•â•â•â•â•â• */
function sNav(d){
  const el=document.getElementById('SD');
  if(!el.value) el.value=td();
  const parts=el.value.split('-');
  const dt=new Date(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]));
  dt.setDate(dt.getDate()+d);
  const y=dt.getFullYear();
  const mo=String(dt.getMonth()+1).padStart(2,'0');
  const dy=String(dt.getDate()).padStart(2,'0');
  el.value=`${y}-${mo}-${dy}`;
  rSched();
}

function rSched(){
  const fdate=document.getElementById('SD').value;
  let sh=[...DB.shifts];if(fdate)sh=sh.filter(s=>s.date===fdate);
  sh.sort((a,b)=>a.date.localeCompare(b.date));
  const el=document.getElementById('SL');
  if(!sh.length){el.innerHTML=`<div class="EMPTY card"><div class="EMJ">ğŸ“‹</div><p>${fdate?`×œ× × ××¦× ×¡×™×“×•×¨ ×œ-${fd(fdate)}`:'×œ× × ××¦××• ×¡×™×“×•×¨×™×'}</p>${fdate?`<button class="btn bP" style="margin-top:11px" onclick="openNewShiftDate('${fdate}')">â• ×¦×•×¨ ×¡×™×“×•×¨ ×œ-${sd(fdate)}</button>`:''}</div>`;return;}
  el.innerHTML=sh.map(s=>{
    const past=s.date<td();const tot=stt(s);const rev=srev(s).toFixed(0);
    const chips=s.workers.map(wid=>{
      const isM=wid===s.manager;const isD=isDriver(wid,s);const onLeave=workerOnLeave(wid,s.date);
      if(onLeave)return`<span class="CP" style="cursor:default;background:#fde8e6;color:var(--R);border-color:var(--R)">ğŸ–ï¸ ${un(wid)}</span>`;
      return`<span class="CP ${isM?'sel':isD?'drv':''}" style="cursor:default">${isM?'â­':isD?'ğŸš—':'ğŸ‘¤'} ${un(wid)}</span>`;
    }).join('');

    // Cars block
    const driverPays=(s.status==='full'||s.status==='partial');
    const carsHTML=(s.cars||[]).filter(c=>c.driver).map((c,i)=>`
      <div style="background:#f0f4ff;border-radius:8px;padding:8px 12px;margin-bottom:6px;font-size:.81rem">
        <div style="font-weight:700;color:var(--U);margin-bottom:4px">ğŸš— ×¨×›×‘ ${i+1} â€“ × ×”×’: ${un(c.driver)}
          ${driverPays?`<span class="BD bb" style="margin-right:6px">+â‚ª${s.carRate||0} × ×¡×™×¢×”${s.carKm?` (${s.carKm}×§×´× Ã— â‚ª${s.carKmRate||0})`:''}</span>`:'<span class="BD bk" style="margin-right:6px">×ª×©×œ×•× × ×¡×™×¢×” ×™×©×•×œ× ×‘×‘×™×¦×•×¢</span>'}
        </div>
        <div>× ×•×¡×¢×™×: ${c.passengers.map(pid=>`<span class="BD bb" style="margin-left:4px">${un(pid)}</span>`).join('')||'<span style="color:var(--S)">××™×Ÿ × ×•×¡×¢×™×</span>'}</div>
      </div>`).join('');

    // Tree rows
    const driverPaysSched=(s.status==='full'||s.status==='partial');
    const trows=s.workers.map(wid=>{
      const t=Number((s.wt||{})[wid]||0);const h=Number((s.hours||{})[wid]||0);const onLeave=workerOnLeave(wid,s.date);
      const isD=isDriver(wid,s);const carPay=isD&&driverPaysSched?Number(s.carRate||0):0;
      const totalPay=(t*s.rate+carPay).toFixed(0);
      if(onLeave)return`<tr style="background:#fde8e6"><td>${un(wid)}</td><td colspan="4" style="color:var(--R);font-weight:700">ğŸ–ï¸ ×—×•×¤×© ×××•×©×¨</td></tr>`;
      return`<tr><td><div style="display:flex;align-items:center;gap:6px"><div style="width:20px;height:20px;border-radius:50%;background:${uc(wid)};display:flex;align-items:center;justify-content:center;color:white;font-size:.66rem;font-weight:800">${un(wid).charAt(0)}</div>${un(wid)}${wid===s.manager?' â­':''}${isD&&driverPaysSched?' ğŸš—':''}</div></td>
        <td style="text-align:center;font-weight:700">${t||'â€”'}</td>
        <td style="text-align:center">
          <input type="number" min="0" step="0.5" class="inline-input" value="${h||''}" placeholder="0" style="width:60px"
            onchange="saveHours(${s.id},${wid},this.value)" title="×©×¢×•×ª ×¢×‘×•×“×” â€“ ×œ×—×¥ Enter ×œ×©××•×¨" />
        </td>
        <td style="text-align:center;font-size:.78rem;color:${isD&&driverPaysSched?'var(--U)':'var(--S)'}">â‚ª${totalPay}${isD&&driverPaysSched?` <span title="×›×•×œ×œ â‚ª${carPay} × ×¡×™×¢×”" style="font-size:.7rem">(+× ×¡×™×¢×”)</span>`:''}</td></tr>`;
    }).join('');

    return`<div class="card" style="border-right:5px solid ${tc(s.type)};padding:0;overflow:hidden">
      <div style="padding:12px 17px;border-bottom:1px solid var(--P);display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:7px">
        <div>
          <div style="font-weight:800;font-size:.95rem">${fd(s.date)}</div>
          <div style="display:flex;gap:5px;margin-top:4px;flex-wrap:wrap">
            <span style="background:${tc(s.type)};color:white;padding:1px 9px;border-radius:13px;font-size:.71rem;font-weight:700">${s.type}</span>
            ${ssBadge(s.status)}
            ${tot?`<span class="BD bv">ğŸŒ¿ ${tot}</span><span class="BD bg2">â‚ª${rev}</span>`:''}
            ${s.timeStart?`<span class="BD bb">ğŸ• ${s.timeStart}${s.timeEnd?'â€“'+s.timeEnd:''}</span>`:''}
          </div>
        </div>
        <div style="display:flex;gap:5px"><button class="btn bG bSm" onclick="editShift(${s.id})">âœï¸</button><button class="btn bD bSm" onclick="delShift(${s.id})">ğŸ—‘ï¸</button></div>
      </div>
      <div style="padding:11px 17px">
        <div class="IR"><span class="LB">ğŸ“</span><span>${s.location||'â€”'}${s.gmaps?` <a href="${s.gmaps}" target="_blank" class="ML" style="margin-right:5px">ğŸ—ºï¸ Google</a>`:''}${s.waze?` <a href="${s.waze}" target="_blank" class="ML">ğŸ§­ Waze</a>`:''}</span></div>
        <div class="IR"><span class="LB">ğŸ’° ×ª×¢×¨×™×£:</span><span>â‚ª${s.rate} ×œ×¢×¥${s.carKm?` Â· ${s.carKm}×§×´× Ã— â‚ª${s.carKmRate||0} = â‚ª${s.carRate||0} ×œ× ×”×’`:(s.carRate?` Â· â‚ª${s.carRate} × ×¡×™×¢×”`:'')}</span></div>
        ${s.notes?`<div class="IR"><span class="LB">ğŸ“</span><span style="font-style:italic;color:var(--H)">${s.notes}</span></div>`:''}
        <div style="margin-top:9px;font-size:.77rem;font-weight:700;color:var(--S)">ğŸ‘· ×¦×•×•×ª:</div>
        <div class="CPS" style="margin-top:4px">${chips}</div>
        ${carsHTML?`<div style="margin-top:10px">${carsHTML}</div>`:''}
        ${tot?`<div class="SEP"></div>
          <div style="font-weight:700;font-size:.79rem;color:var(--V);margin-bottom:5px">ğŸŒ¿ ×¢×¦×™× ×•×©×¢×•×ª ×œ×¤×™ ×¢×•×‘×“</div>
          <div class="TW"><table class="TTR"><thead><tr><th>×¢×•×‘×“</th><th>×¢×¦×™×</th><th>×©×¢×•×ª (×¢×¨×™×›×”)</th><th>×”×›× ×¡×”</th></tr></thead><tbody>${trows}</tbody></table></div>
          <div class="SUMBOX">×¡×”×´×›: <strong>${tot} ×¢×¦×™×</strong> Â· <strong>â‚ª${(Number(rev)+(s.cars||[]).filter(c=>c.driver).length*(s.carRate||0)).toFixed(0)}</strong> (×›×•×œ×œ × ×¡×™×¢×•×ª)</div>`:
          `<div style="margin-top:7px;font-size:.77rem;color:var(--S);font-style:italic">â³ ×¢×¦×™× ×˜×¨× ×”×•×›× ×¡×•</div>`}
      </div>
    </div>`;
  }).join('');
}

/* â”€â”€ Cars section in modal â”€â”€ */
function rebuildCars(){
  const n=parseInt(document.getElementById('S-VH').value)||0;
  const drivers=getSelW().map(id=>DB.users.find(u=>u.id===id)).filter(u=>u?.hasCar);
  const passengers=getSelW().map(id=>DB.users.find(u=>u.id===id)).filter(Boolean);
  const prev=(window._prevCars||[]);
  const wrap=document.getElementById('S-CARS-WRAP');
  if(!n){wrap.innerHTML='';window._prevCars=[];return;}
  let html='';
  for(let i=0;i<n;i++){
    const pc=prev[i]||{};
    html+=`<div style="border:1.5px solid #b8c8e8;border-radius:9px;padding:10px;margin-bottom:8px">
      <div style="font-weight:700;font-size:.82rem;color:var(--U);margin-bottom:7px">ğŸš— ×¨×›×‘ ${i+1}</div>
      <div class="FR" style="margin-bottom:6px">
        <div class="FF"><label>× ×”×’</label>
          <select class="car-driver" data-car="${i}" onchange="rebuildPassChips(${i})">
            <option value="">-- ×‘×—×¨ × ×”×’ --</option>
            ${drivers.map(d=>`<option value="${d.id}" ${pc.driver===d.id?'selected':''}>${d.name}</option>`).join('')}
          </select>
        </div>
      </div>
      <div style="font-size:.77rem;font-weight:700;color:var(--B);margin-bottom:5px">× ×•×¡×¢×™×:</div>
      <div class="chips car-pass-chips" id="car-chips-${i}">
        ${passengers.filter(u=>u.id!==(pc.driver||0)).map(u=>`<div class="CP ${pc.passengers?.includes(u.id)?'sel':''}" onclick="this.classList.toggle('sel')" data-uid="${u.id}">${u.name}</div>`).join('')}
      </div>
    </div>`;
  }
  wrap.innerHTML=html;
  window._prevCars=prev;
}
function rebuildPassChips(i){
  const dv=parseInt(document.querySelector(`[data-car="${i}"].car-driver`)?.value)||0;
  const chips=document.getElementById(`car-chips-${i}`);if(!chips)return;
  const sel=getSelW().map(id=>DB.users.find(u=>u.id===id)).filter(u=>u&&u.id!==dv);
  chips.innerHTML=sel.map(u=>`<div class="CP" onclick="this.classList.toggle('sel')" data-uid="${u.id}">${u.name}</div>`).join('');
}
function calcCarRate(){
  const km=parseFloat(document.getElementById('S-KM').value)||0;
  const kmr=parseFloat(document.getElementById('S-KMR').value)||0;
  const total=(km*kmr).toFixed(1);
  document.getElementById('S-CR').value=total;
}
function getCars(){
  const n=parseInt(document.getElementById('S-VH').value)||0;const cars=[];
  for(let i=0;i<n;i++){
    const dEl=document.querySelector(`[data-car="${i}"].car-driver`);
    const driver=parseInt(dEl?.value)||0;if(!driver)continue;
    const passengers=[...document.querySelectorAll(`#car-chips-${i} .CP.sel`)].map(el=>parseInt(el.dataset.uid)).filter(Boolean);
    cars.push({driver,passengers});
  }
  return cars;
}

/* â”€â”€ Shift modal â”€â”€ */
function getSelW(){return[...document.querySelectorAll('#S-WC .CP.sel')].map(el=>{const nm=el.textContent.trim().replace(' ğŸš—','');return DB.users.find(x=>x.name===nm)?.id}).filter(Boolean)}
function tWC(el){el.classList.toggle('sel');rMgr();rebuildCars();bTT({},{})}
function rMgr(){const s=getSelW();const mg=document.getElementById('S-MGR');const cv=mg.value;mg.innerHTML='<option value="">-- ×‘×—×¨ --</option>'+DB.users.filter(u=>s.includes(u.id)).map(u=>`<option value="${u.id}">${u.name}</option>`).join('');if(cv)mg.value=cv}
function bTT(exT,exH){
  const s=getSelW();const rt=parseFloat(document.getElementById('S-RT').value)||0;const cr=parseFloat(document.getElementById('S-CR').value)||0;
  document.getElementById('S-TTB').innerHTML=s.map(id=>{const vt=exT[id]!==undefined?exT[id]:'';const vh=exH[id]!==undefined?exH[id]:'';
    return`<tr><td><div style="display:flex;align-items:center;gap:5px"><div style="width:20px;height:20px;border-radius:50%;background:${uc(id)};display:flex;align-items:center;justify-content:center;color:white;font-size:.66rem;font-weight:800">${un(id).charAt(0)}</div>${un(id)}</div></td>
    <td><input type="number" min="0" class="TINP" data-uid="${id}" value="${vt}" placeholder="0" oninput="onTI(this)" /></td>
    <td><input type="number" min="0" step="0.5" class="HINP" data-uid="${id}" value="${vh}" placeholder="0" /></td>
    <td><label class="TGL"><input type="checkbox" class="ACHK" data-uid="${id}" ${vt!==''&&Number(vt)>0?'checked':''}><span class="TSL"></span></label></td>
    <td class="TREV" data-uid="${id}" style="font-weight:700;font-size:.8rem;color:var(--V)">â‚ª0</td></tr>`;
  }).join('');calcS();
}
function onTI(inp){calcS()}
function calcS(){
  const rt=parseFloat(document.getElementById('S-RT').value)||0;const cr=parseFloat(document.getElementById('S-CR').value)||0;
  const wSel=getSelW();
  let tot=0;
  wSel.forEach(id=>{
    const ti=document.querySelector(`.TINP[data-uid="${id}"]`);const rv=document.querySelector(`.TREV[data-uid="${id}"]`);
    if(!ti||!rv)return;const t=Number(ti.value||0);
    const cars=getCars();const isDrv=cars.some(c=>c.driver===id);
    const inc=t*rt+(isDrv?cr:0);
    rv.textContent='â‚ª'+inc.toFixed(0);tot+=t;
  });
  const sb=document.getElementById('S-SUM');
  if(tot>0){sb.style.display='block';document.getElementById('S-TOTT').textContent=tot;document.getElementById('S-TOTR').textContent='â‚ª'+(tot*rt).toFixed(0)}
  else sb.style.display='none';
}
function getTT(){const d={};[...document.querySelectorAll('.TINP')].forEach(i=>d[i.dataset.uid]=Number(i.value)||0);return d}
function getHH(){const d={};[...document.querySelectorAll('.HINP')].forEach(i=>d[i.dataset.uid]=Number(i.value)||0);return d}

function buildWChipsForShift(selIds=[]){
  const avail=activeWorkers();
  document.getElementById('S-WC').innerHTML=avail.map(u=>`<div class="CP ${selIds.includes(u.id)?'sel':''}" onclick="tWC(this)">${u.name}${u.hasCar?' ğŸš—':''}</div>`).join('');
  rMgr();
}
function openNewShift(date){
  document.getElementById('S-TTL').textContent='â• ×¡×™×“×•×¨ ×¢×‘×•×“×” ×—×“×©';
  document.getElementById('S-ID').value='';
  document.getElementById('S-DT').value=date||tmr();
  document.getElementById('S-TP').value='×–××™×¨×”';
  document.getElementById('S-ST').value='pending';
  ['S-LOC','S-GM','S-WZ','S-NT','S-TS','S-TE'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('S-RT').value='';document.getElementById('S-VH').value='';
  document.getElementById('S-CR').value='';document.getElementById('S-KM').value='';document.getElementById('S-KMR').value='';
  window._prevCars=[];document.getElementById('S-CARS-WRAP').innerHTML='';
  buildWChipsForShift([]);bTT({},{});omo('MOS');
}
function openNewShiftDate(d){openNewShift(d)}
function editShift(id){
  const s=DB.shifts.find(x=>x.id===id);if(!s)return;
  document.getElementById('S-TTL').textContent='âœï¸ ×¢×¨×™×›×ª ×¡×™×“×•×¨';
  document.getElementById('S-ID').value=id;document.getElementById('S-DT').value=s.date;
  document.getElementById('S-TP').value=s.type;document.getElementById('S-ST').value=s.status||'pending';
  document.getElementById('S-LOC').value=s.location||'';document.getElementById('S-GM').value=s.gmaps||'';document.getElementById('S-WZ').value=s.waze||'';
  document.getElementById('S-RT').value=s.rate||'';document.getElementById('S-NT').value=s.notes||'';
  document.getElementById('S-VH').value=s.vehicles||0;document.getElementById('S-CR').value=s.carRate||'';
  document.getElementById('S-KM').value=s.carKm||'';document.getElementById('S-KMR').value=s.carKmRate||'';
  document.getElementById('S-TS').value=s.timeStart||'';document.getElementById('S-TE').value=s.timeEnd||'';
  buildWChipsForShift(s.workers||[]);
  window._prevCars=s.cars||[];
  setTimeout(()=>{rMgr();document.getElementById('S-MGR').value=s.manager||'';rebuildCars();
    // restore car selections
    setTimeout(()=>{
      (s.cars||[]).forEach((c,i)=>{
        const dEl=document.querySelector(`[data-car="${i}"].car-driver`);if(dEl){dEl.value=c.driver||'';rebuildPassChips(i);}
        setTimeout(()=>{const chips=document.querySelectorAll(`#car-chips-${i} .CP`);
          chips.forEach(el=>{if(c.passengers?.includes(parseInt(el.dataset.uid)))el.classList.add('sel')});},50);
      });
    },50);
    bTT(s.wt||{},s.hours||{});
  },30);omo('MOS');
}
function saveShift(){
  const date=document.getElementById('S-DT').value;if(!date){toast('× × ×œ××œ× ×ª××¨×™×š','er');return}
  const rt=parseFloat(document.getElementById('S-RT').value)||0;if(!rt){toast('× × ×œ×”×›× ×™×¡ ×ª×¢×¨×™×£','er');return}
  const obj={date,type:document.getElementById('S-TP').value,status:document.getElementById('S-ST').value,
    location:document.getElementById('S-LOC').value,gmaps:document.getElementById('S-GM').value,waze:document.getElementById('S-WZ').value,
    workers:getSelW(),manager:parseInt(document.getElementById('S-MGR').value)||null,
    vehicles:parseInt(document.getElementById('S-VH').value)||0,carRate:parseFloat(document.getElementById('S-CR').value)||0,
    carKm:parseFloat(document.getElementById('S-KM').value)||0,carKmRate:parseFloat(document.getElementById('S-KMR').value)||0,
    cars:getCars(),timeStart:document.getElementById('S-TS').value,timeEnd:document.getElementById('S-TE').value,
    rate:rt,notes:document.getElementById('S-NT').value,wt:getTT(),hours:getHH()};
  const eid=parseInt(document.getElementById('S-ID').value);
  if(eid){const i=DB.shifts.findIndex(s=>s.id===eid);DB.shifts[i]={...DB.shifts[i],...obj};toast('âœ… ×”×¡×™×“×•×¨ ×¢×•×“×›×Ÿ')}
  else{obj.id=DB.nsid++;DB.shifts.push(obj);toast('âœ… ×”×¡×™×“×•×¨ × ×©××¨')}
  sdb();cmo('MOS');rSched();
}
function saveHours(sid,uid,val){
  const s=DB.shifts.find(x=>x.id===sid);if(!s)return;
  if(!s.hours)s.hours={};
  s.hours[uid]=parseFloat(val)||0;
  sdb();toast('âœ… ×©×¢×•×ª ×¢×•×“×›× ×•');
}
function delShift(id){if(!confirm('×œ××—×•×§ ××ª ×”×¡×™×“×•×¨?'))return;DB.shifts=DB.shifts.filter(s=>s.id!==id);sdb();rSched();toast('ğŸ—‘ï¸ × ××—×§','er')}

/* â•â•â•â•â•â•â•â•â•â• WORKERS â•â•â•â•â•â•â•â•â•â• */
function rWorkers(){
  const list=DB.users.filter(u=>u.id!==1);
  document.getElementById('WTB').innerHTML=list.map(u=>{
    const sh=DB.shifts.filter(s=>s.workers.includes(u.id)).length;
    const tr=wtr(u.id,DB.shifts);const active=u.active!==false;
    return`<tr style="${active?'':'opacity:.55'}">
      <td><div style="display:flex;align-items:center;gap:7px"><div style="width:28px;height:28px;border-radius:50%;background:${uc(u.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.79rem;flex-shrink:0">${u.name.charAt(0)}</div>
        <div><div style="font-weight:700">${u.name}</div>${u.phone?`<div style="font-size:.7rem;color:var(--S)">${u.phone}</div>`:''}</div></div></td>
      <td><code style="background:var(--P);padding:1px 7px;border-radius:5px;font-size:.78rem">${u.username}</code></td>
      <td>${u.isAdmin?'<span class="BD bg2">×× ×”×œ</span>':'<span class="BD bv">×¢×•×‘×“</span>'}</td>
      <td>${u.hasCar?'ğŸš—':'â€”'}</td>
      <td><span class="${active?'pill-active':'pill-inactive'}">${active?'×¤×¢×™×œ':'×œ× ×¤×¢×™×œ'}</span></td>
      <td><span class="BD bb">${sh}</span></td>
      <td><span class="BD bv">ğŸŒ¿ ${tr}</span></td>
      <td><div style="display:flex;gap:5px">
        <button class="btn bS bSm" onclick="editWorker(${u.id})">âœï¸</button>
        <button class="btn ${active?'bD':'bP'} bSm" onclick="toggleActive(${u.id})">${active?'×”×©×”×”':'×”×¤×¢×œ'}</button>
        <button class="btn bD bSm" onclick="delWorker(${u.id})">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`;
  }).join('');
}
function toggleActive(id){const u=DB.users.find(x=>x.id===id);if(!u)return;u.active=u.active===false?true:false;sdb();rWorkers();toast(u.active?'âœ… ×¢×•×‘×“ ×”×•×¤×¢×œ':'ğŸ”´ ×¢×•×‘×“ ×”×•×©×”×”')}
function openNewWorker(){['W-ID','W-NM','W-US','W-PW','W-PH'].forEach(i=>document.getElementById(i).value='');document.getElementById('W-ADM').checked=false;document.getElementById('W-CAR').checked=false;document.getElementById('W-ACT').checked=true;document.getElementById('W-TTL').textContent='â• ×¢×•×‘×“ ×—×“×©';omo('MOW')}
function editWorker(id){const u=DB.users.find(x=>x.id===id);if(!u)return;document.getElementById('W-TTL').textContent='âœï¸ ×¢×¨×™×›×ª ×¢×•×‘×“';document.getElementById('W-ID').value=id;document.getElementById('W-NM').value=u.name;document.getElementById('W-US').value=u.username;document.getElementById('W-PW').value=u.password;document.getElementById('W-PH').value=u.phone||'';document.getElementById('W-ADM').checked=u.isAdmin;document.getElementById('W-CAR').checked=u.hasCar;document.getElementById('W-ACT').checked=u.active!==false;omo('MOW')}
function saveWorker(){
  const nm=document.getElementById('W-NM').value.trim(),us=document.getElementById('W-US').value.trim(),pw=document.getElementById('W-PW').value.trim();
  if(!nm||!us||!pw){toast('× × ×œ××œ× ×©×, ×©× ××©×ª××© ×•×¡×™×¡××”','er');return}
  const d={name:nm,username:us,password:pw,phone:document.getElementById('W-PH').value,isAdmin:document.getElementById('W-ADM').checked,hasCar:document.getElementById('W-CAR').checked,active:document.getElementById('W-ACT').checked};
  const eid=parseInt(document.getElementById('W-ID').value);
  if(eid){const i=DB.users.findIndex(u=>u.id===eid);DB.users[i]={...DB.users[i],...d};toast('âœ… ×¢×•×“×›×Ÿ')}
  else{if(DB.users.find(u=>u.username===us)){toast('×©× ××©×ª××© ×ª×¤×•×¡','er');return}DB.users.push({id:DB.nuid++,...d});toast('âœ… ×¢×•×‘×“ ×—×“×© × ×•×¡×£')}
  sdb();cmo('MOW');rWorkers();
}
function delWorker(id){if(!confirm('×œ××—×•×§ ××ª ×”×¢×•×‘×“?'))return;DB.users=DB.users.filter(u=>u.id!==id);sdb();rWorkers();toast('ğŸ—‘ï¸ × ××—×§','er')}

/* â•â•â•â•â•â•â•â•â•â• LEAVE REQUESTS (admin) â•â•â•â•â•â•â•â•â•â• */
function rLeave(){
  updateLeaveBadge();
  const pending=DB.leaveRequests.filter(r=>r.status==='pending');
  const all=[...DB.leaveRequests].sort((a,b)=>b.createdAt.localeCompare(a.createdAt));
  document.getElementById('LEAVE-PENDING').innerHTML=pending.length?pending.map(r=>leaveCard(r,true)).join(''):'<div class="EMPTY"><div class="EMJ">âœ…</div><p>××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª</p></div>';
  document.getElementById('LEAVE-ALL').innerHTML=all.length?all.map(r=>leaveCard(r,false)).join(''):'<div class="EMPTY"><p>××™×Ÿ ×‘×§×©×•×ª</p></div>';
}
function leaveCard(r,showActions){
  const st={pending:'pending',approved:'approved',rejected:'rejected'}[r.status]||'pending';
  const stLbl={pending:'â³ ×××ª×™×Ÿ',approved:'âœ… ××•×©×¨',rejected:'âŒ × ×“×—×”'}[r.status];
  return`<div class="leave-req ${st}">
    <div style="flex:1">
      <div style="font-weight:700;font-size:.9rem">${un(r.uid)}</div>
      <div style="font-size:.82rem;color:var(--S);margin-top:2px">${sd(r.from)} â€“ ${sd(r.to)}</div>
      ${r.note?`<div style="font-size:.8rem;font-style:italic;color:var(--B);margin-top:3px">${r.note}</div>`:''}
    </div>
    <span class="BD ${r.status==='approved'?'bv':r.status==='rejected'?'br':'bg2'}">${stLbl}</span>
    ${showActions&&r.status==='pending'?`
      <button class="btn bP bSm" onclick="approveLeave(${r.id})">âœ… ××©×¨</button>
      <button class="btn bD bSm" onclick="rejectLeave(${r.id})">âŒ ×“×—×”</button>`:''}`+'</div>';
}
function approveLeave(id){
  const r=DB.leaveRequests.find(x=>x.id===id);if(!r)return;r.status='approved';sdb();rLeave();updateLeaveBadge();toast('âœ… ×—×•×¤×© ××•×©×¨');
}
function rejectLeave(id){
  const r=DB.leaveRequests.find(x=>x.id===id);if(!r)return;r.status='rejected';sdb();rLeave();updateLeaveBadge();toast('âŒ ×‘×§×©×” × ×“×—×ª×”','er');
}

/* â•â•â•â•â•â•â•â•â•â• ANALYTICS â•â•â•â•â•â•â•â•â•â• */
let curAt='lb';
const ATLIST=['lb','monthly','season','location','attend','hist'];
function atab(t){curAt=t;document.querySelectorAll('#ATBS .TB').forEach((el,i)=>el.classList.toggle('ON',ATLIST[i]===t));document.querySelectorAll('.AP-PANEL').forEach(el=>el.style.display='none');document.getElementById('a-'+t).style.display='block';rA()}
function getPd(){const p=document.getElementById('AP').value;const to=td();let from;if(p==='week'){const d=new Date();d.setDate(d.getDate()-7);from=d.toISOString().split('T')[0]}else if(p==='month'){const d=new Date();d.setMonth(d.getMonth()-1);from=d.toISOString().split('T')[0]}else if(p==='season'){const d=new Date();d.setMonth(d.getMonth()-3);from=d.toISOString().split('T')[0]}else if(p==='year'){const d=new Date();d.setFullYear(d.getFullYear()-1);from=d.toISOString().split('T')[0]}else from='2020-01-01';return{from,to}}
function rA(){
  const aw=document.getElementById('AW');const cw=aw.value;
  aw.innerHTML='<option value="">×›×•×œ×</option>'+DB.users.filter(u=>!u.isAdmin).map(u=>`<option value="${u.id}">${u.name}</option>`).join('');if(cw)aw.value=cw;
  const{from,to}=getPd();const wf=parseInt(aw.value)||null;
  let sh=DB.shifts.filter(s=>s.date>=from&&s.date<=to&&s.status!=='cancelled');if(wf)sh=sh.filter(s=>s.workers.includes(wf));
  const tot=sh.reduce((a,s)=>a+stt(s),0);const rev=sh.reduce((a,s)=>a+srev(s),0);
  document.getElementById('as-s').textContent=sh.length;document.getElementById('as-t').textContent=tot;
  document.getElementById('as-a').textContent=sh.length?(tot/sh.length).toFixed(1):0;document.getElementById('as-r').textContent='â‚ª'+rev.toFixed(0);
  const na=DB.users.filter(u=>!u.isAdmin);

  if(curAt==='lb'){
    const lb=na.map(u=>({name:u.name,id:u.id,trees:wtr(u.id,sh),rev:wrv(u.id,sh),hours:wHours(u.id,sh),sh:sh.filter(s=>s.workers.includes(u.id)).length})).sort((a,b)=>b.trees-a.trees);
    const mx=Math.max(...lb.map(r=>r.trees),1);const M=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    document.getElementById('a-lb').innerHTML=`<div class="G2">
      <div class="card"><div class="CT">ğŸ† ×“×™×¨×•×’ ×¢×¦×™×</div>${lb.map((r,i)=>`<div class="BR"><div class="BN">${M[i]||''} ${r.name}</div><div class="BT"><div class="BF" style="width:${(r.trees/mx*100).toFixed(0)}%;background:${uc(r.id)}">${r.trees>10?r.trees:''}</div></div><div class="BV">${r.trees} ğŸŒ¿</div></div>`).join('')}</div>
      <div class="card"><div class="CT">ğŸ’° ×”×›× ×¡×•×ª (×›×•×œ×œ × ×¡×™×¢×•×ª)</div>${lb.map(r=>{const mr=Math.max(...lb.map(x=>x.rev),1);return`<div class="BR"><div class="BN">${r.name}</div><div class="BT"><div class="BF" style="width:${(r.rev/mr*100).toFixed(0)}%;background:${uc(r.id)}">${r.rev>200?'â‚ª'+r.rev.toFixed(0):''}</div></div><div class="BV">â‚ª${r.rev.toFixed(0)}</div></div>`}).join('')}</div>
    </div>
    <div class="card"><div class="CT">ğŸ“Š ×˜×‘×œ×ª ×‘×™×¦×•×¢×™×</div><div class="TW"><table><thead><tr><th>#</th><th>×¢×•×‘×“</th><th>××©××¨×•×ª</th><th>×¢×¦×™×</th><th>×××•×¦×¢/××©××¨×ª</th><th>×©×¢×•×ª</th><th>×”×›× ×¡×”</th></tr></thead>
    <tbody>${lb.map((r,i)=>`<tr><td>${M[i]||i+1}</td><td><div style="display:flex;align-items:center;gap:6px"><div style="width:22px;height:22px;border-radius:50%;background:${uc(r.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.7rem">${r.name.charAt(0)}</div><strong>${r.name}</strong></div></td>
    <td>${r.sh}</td><td><strong>${r.trees} ğŸŒ¿</strong></td><td>${r.sh?(r.trees/r.sh).toFixed(1):0}</td><td>${r.hours}×©</td><td><strong>â‚ª${r.rev.toFixed(0)}</strong></td></tr>`).join('')}</tbody></table></div></div>`;
  }

  if(curAt==='monthly'){
    const months=[];const now=new Date();for(let i=5;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1);months.push({key:mkey(d.toISOString().split('T')[0]),lbl:mnS(d.toISOString().split('T')[0])})}
    document.getElementById('a-monthly').innerHTML=`<div class="card"><div class="CT">ğŸ“… ×¢×¦×™× ×œ×¤×™ ×¢×•×‘×“ â€“ 6 ×—×•×“×©×™×</div>
      ${na.map(u=>{const md=months.map(m=>{const ms=DB.shifts.filter(s=>mkey(s.date)===m.key&&s.workers.includes(u.id)&&s.status!=='cancelled');return{lbl:m.lbl,trees:wtr(u.id,ms)}});const mx=Math.max(...md.map(x=>x.trees),1);const tot=md.reduce((a,x)=>a+x.trees,0);
        return`<div style="margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--P)">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><div style="width:24px;height:24px;border-radius:50%;background:${uc(u.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.75rem">${u.name.charAt(0)}</div><strong style="font-size:.86rem">${u.name}</strong><span class="BD bv" style="margin-right:auto">ğŸŒ¿ ${tot}</span></div>
          <div class="MCH">${md.map(m=>`<div><div class="MCH-B" style="height:${mx>0?(m.trees/mx*100).toFixed(0):0}%;background:${uc(u.id)};opacity:${m.trees>0?1:.2}"><span class="TT">${m.lbl}: ${m.trees}</span></div><div class="MCH-L">${m.lbl}</div></div>`).join('')}</div>
        </div>`;}).join('')}
    </div>`;
  }

  if(curAt==='season'){const mx=Math.max(...na.map(u=>wtr(u.id,sh)),1);document.getElementById('a-season').innerHTML=`<div class="card"><div class="CT">ğŸŒ¿ ×”×©×•×•××” ×œ××•×¨×š ×”×¢×•× ×”</div>${na.map(u=>{const trees=wtr(u.id,sh);const rev=wrv(u.id,sh);const ms=sh.filter(s=>s.workers.includes(u.id));const avg=ms.length?(trees/ms.length).toFixed(1):0;return`<div style="margin-bottom:14px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:5px"><div style="display:flex;align-items:center;gap:7px"><div style="width:25px;height:25px;border-radius:50%;background:${uc(u.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.74rem">${u.name.charAt(0)}</div><strong>${u.name}</strong></div><div style="display:flex;gap:5px"><span class="BD bv">ğŸŒ¿ ${trees}</span><span class="BD bg2">â­ ${avg}</span><span class="BD bb">â‚ª${rev.toFixed(0)}</span></div></div><div class="PB"><div class="PF" style="width:${(trees/mx*100).toFixed(0)}%;background:${uc(u.id)}"></div></div></div>`;}).join('')}</div>`}

  if(curAt==='location'){const by={};sh.forEach(s=>{const l=s.location||'×œ× ×”×•×’×“×¨';by[l]=by[l]||{c:0,t:0,r:0};by[l].c++;by[l].t+=stt(s);by[l].r+=srev(s)});const arr=Object.entries(by).sort((a,b)=>b[1].r-a[1].r);const mx=Math.max(...arr.map(([,v])=>v.r),1);document.getElementById('a-location').innerHTML=`<div class="card"><div class="CT">ğŸ“ ×”×›× ×¡×•×ª ×œ×¤×™ ××™×§×•×</div>${arr.map(([loc,v])=>`<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;flex-wrap:wrap;gap:5px"><strong style="font-size:.84rem">${loc}</strong><div style="display:flex;gap:5px"><span class="BD bv">ğŸŒ¿ ${v.t}</span><span class="BD bg2">â‚ª${v.r.toFixed(0)}</span><span class="BD bk">${v.c} ××©××¨×•×ª</span></div></div><div class="PB"><div class="PF" style="width:${(v.r/mx*100).toFixed(0)}%;background:var(--H)"></div></div></div>`).join('')||'<div class="EMPTY"><p>××™×Ÿ × ×ª×•× ×™×</p></div>'}</div>`}

  if(curAt==='attend'){document.getElementById('a-attend').innerHTML=`<div class="card"><div class="CT">âœ… × ×•×›×—×•×ª</div><div class="TW"><table><thead><tr><th>×¢×•×‘×“</th><th>×©×•×‘×¥</th><th>× ×›×—</th><th>×¢×“×¨×•×ª</th><th>% × ×•×›×—×•×ª</th></tr></thead><tbody>${na.map(u=>{const asgn=sh.filter(s=>s.workers.includes(u.id));const pres=asgn.filter(s=>Number((s.wt||{})[u.id]||0)>0).length;const abs=asgn.length-pres;const pct=asgn.length?(pres/asgn.length*100).toFixed(0):0;const col=pct>=80?'var(--V)':pct>=50?'var(--H)':'var(--R)';return`<tr><td><div style="display:flex;align-items:center;gap:6px"><div style="width:22px;height:22px;border-radius:50%;background:${uc(u.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:.7rem">${u.name.charAt(0)}</div><strong>${u.name}</strong></div></td><td>${asgn.length}</td><td style="color:var(--V);font-weight:700">${pres}</td><td style="color:var(--R);font-weight:700">${abs}</td><td><div style="display:flex;align-items:center;gap:7px"><div class="PB" style="width:70px;margin:0"><div class="PF" style="width:${pct}%;background:${col}"></div></div><span style="font-weight:700;font-size:.79rem;color:${col}">${pct}%</span></div></td></tr>`}).join('')}</tbody></table></div></div>`}

  if(curAt==='hist'){const sorted=[...sh].sort((a,b)=>b.date.localeCompare(a.date));document.getElementById('a-hist').innerHTML=`<div class="card"><div class="CT">ğŸ“‹ ×”×™×¡×˜×•×¨×™×” ××œ××”</div><div class="TW"><table><thead><tr><th>×ª××¨×™×š</th><th>×¡×•×’</th><th>×¡×˜×˜×•×¡</th><th>××™×§×•×</th><th>×¢×¦×™×</th><th>×©×¢×•×ª</th><th>â‚ª/×¢×¥</th><th>×¡×”×´×›</th></tr></thead><tbody>${sorted.map(s=>`<tr><td>${sd(s.date)}</td><td><span style="background:${tc(s.type)};color:white;padding:1px 7px;border-radius:11px;font-size:.69rem;font-weight:700">${s.type}</span></td><td>${ssBadge(s.status)}</td><td style="font-size:.79rem">${s.location||'â€”'}</td><td><strong>${stt(s)}</strong></td><td>${Object.values(s.hours||{}).reduce((a,v)=>a+v,0)}×©</td><td>â‚ª${s.rate}</td><td><strong>â‚ª${srev(s).toFixed(0)}</strong></td></tr>`).join('')||'<tr><td colspan="8" style="text-align:center;padding:16px;color:var(--S)">××™×Ÿ × ×ª×•× ×™×</td></tr>'}</tbody></table></div></div>`}
}

/* â•â•â•â•â•â•â•â•â•â• WORKER HOME â•â•â•â•â•â•â•â•â•â• */
function rHome(){
  if(!CU)return;const uid=CU.id;const color=uc(uid);
  const allMy=DB.shifts.filter(s=>s.workers.includes(uid));
  const past=allMy.filter(s=>s.date<=td()&&s.status!=='cancelled');
  const tot=wtr(uid,past);const rev=wrv(uid,past);
  document.getElementById('W-AV').style.background=color;document.getElementById('W-AV').textContent=CU.name.charAt(0);
  document.getElementById('W-NAME').textContent=`×©×œ×•×, ${CU.name} ğŸ‘‹`;
  document.getElementById('W-SUB').textContent=`${past.length} ××©××¨×•×ª Â· ğŸŒ¿ ${tot} ×¢×¦×™× Â· â‚ª${rev.toFixed(0)}`;

  const na=DB.users.filter(u=>!u.isAdmin);
  // Current month rank
  const nowM=new Date();const curMonthKey=`${nowM.getFullYear()}-${String(nowM.getMonth()+1).padStart(2,'0')}`;
  const curMonthSh=DB.shifts.filter(s=>mkey(s.date)===curMonthKey&&s.status!=='cancelled');
  const lbMonth=na.map(u=>({id:u.id,trees:wtr(u.id,curMonthSh)})).sort((a,b)=>b.trees-a.trees);
  const myRank=lbMonth.findIndex(r=>r.id===uid)+1;const M=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];const curMonthName=mn(td());
  document.getElementById('W-RANK-BADGE').innerHTML=`<div style="background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.4);border-radius:10px;padding:5px 11px;text-align:center"><div style="font-size:1.3rem">${M[myRank-1]||`#${myRank}`}</div><div style="font-size:.66rem;opacity:.85">×”×—×•×“×©</div></div>`;

  const todayS=allMy.find(s=>s.date===td());const tmrS=allMy.find(s=>s.date===tmr());
  const myLeaveToday=workerOnLeave(uid,td());const myLeaveTmr=workerOnLeave(uid,tmr());

  function dayCard(s,isToday,onLeave){
    const label=isToday?`ğŸŒ¿ ×”×™×•× â€“ ${fd(td())}`:`ğŸ“… ××—×¨ â€“ ${fd(tmr())}`;
    const cardCls=isToday?'TODAY-CARD':'TMR-CARD';
    if(onLeave)return`<div class="${cardCls}" style="opacity:.85"><div style="font-weight:800;font-size:.95rem;margin-bottom:10px">${label}</div><div style="text-align:center;padding:16px 0;font-size:2rem">ğŸ–ï¸</div><div style="text-align:center;font-size:.9rem">××ª×” ×‘×—×•×¤×© ×××•×©×¨</div></div>`;
    if(!s)return`<div class="card" style="border-right:4px solid var(--S)"><div class="CT">${label}</div><div class="EMPTY" style="padding:16px"><div class="EMJ">${isToday?'âœ…':'ğŸŒ™'}</div><p>××™×Ÿ ××©××¨×ª ${isToday?'×”×™×•×':'××—×¨'}</p></div></div>`;
    const mt=Number((s.wt||{})[uid]||0);const mh=Number((s.hours||{})[uid]||0);const iM=s.manager===uid;const isD=isDriver(uid,s);
    const doneOrPartial=(s.status==='full'||s.status==='partial');
    const carPayShown=isD&&doneOrPartial?Number(s.carRate||0):0;
    const myCar=(s.cars||[]).find(c=>c.driver===uid||c.passengers?.includes(uid));
    return`<div class="${cardCls}">
      <div style="font-weight:800;font-size:.95rem;margin-bottom:10px">${label}</div>
      ${mt&&isToday?`<div class="BIG-TREE"><div class="BIG-NUM">${mt}</div><div class="BIG-LBL">×¢×¦×™× ×–××¨×ª ×”×™×•×</div><div class="BIG-REV">â‚ª${(mt*s.rate+carPayShown).toFixed(0)}${carPayShown?` (×›×•×œ×œ â‚ª${carPayShown} × ×¡×™×¢×”)`:''}</div></div>`:''}
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
        <span style="background:rgba(255,255,255,.22);color:white;padding:2px 11px;border-radius:13px;font-weight:700;font-size:.79rem">${s.type}</span>
        ${iM?'<span style="background:rgba(255,255,255,.22);color:white;padding:2px 11px;border-radius:13px;font-weight:700;font-size:.79rem">â­ ×× ×”×œ</span>':''}
        ${isD?`<span style="background:rgba(255,255,255,.22);color:white;padding:2px 11px;border-radius:13px;font-weight:700;font-size:.79rem">ğŸš— × ×”×’${s.carKm?` Â· ${s.carKm}×§×´×`:''}</span>`:''}
      </div>
      <div class="IR"><span class="LB">ğŸ“</span><span>${s.location||'â€”'}${s.gmaps?` <a href="${s.gmaps}" target="_blank" class="ML">ğŸ—ºï¸</a>`:''}${s.waze?` <a href="${s.waze}" target="_blank" class="ML">ğŸ§­</a>`:''}</span></div>
      <div class="IR"><span class="LB">ğŸ‘· ×¦×•×•×ª:</span><span style="font-size:.8rem">${s.workers.map(un).join(', ')}</span></div>
      ${myCar?`<div class="IR"><span class="LB">ğŸš— × ×¡×™×¢×”:</span><span style="font-size:.8rem">${isD?`× ×”×’ (${myCar.passengers.map(un).join(', ')||'â€”'})${doneOrPartial?` Â· â‚ª${s.carRate||0}`:' Â· ×™×©×•×œ× ×‘×‘×™×¦×•×¢'}`:`× ×•×¡×¢ ×¢× ${un(myCar.driver)}`}${s.carKm?` Â· ${s.carKm}×§×´× Ã— â‚ª${s.carKmRate||0}`:''}</span></div>`:''}
      ${s.timeStart?`<div class="IR"><span class="LB">ğŸ• ×©×¢×•×ª:</span><span>${s.timeStart}${s.timeEnd?'â€“'+s.timeEnd:''}</span></div>`:''}
      ${s.notes?`<div class="IR"><span class="LB">ğŸ“</span><span style="font-weight:700">${s.notes}</span></div>`:''}
      ${isToday&&!mt?`<button class="btn bP bSm" style="margin-top:10px;width:100%;justify-content:center" onclick="openSelfReport(${s.id})">ğŸŒ¿ ×“×•×•×— ×›××•×ª ×¢×¦×™× ×•×©×¢×•×ª</button>`:''}
      ${isToday&&mt?`<button class="btn bS bSm" style="margin-top:8px;width:100%;justify-content:center" onclick="openSelfReport(${s.id})">âœï¸ ×¢×“×›×Ÿ ×¢×¦×™×</button>`:''}
    </div>`;
  }
  document.getElementById('W-DAYROW').innerHTML=dayCard(todayS,true,myLeaveToday)+dayCard(tmrS,false,myLeaveTmr);

  // Monthly
  const months=[];const now2=new Date();for(let i=5;i>=0;i--){const d=new Date(now2.getFullYear(),now2.getMonth()-i,1);months.push({key:mkey(d.toISOString().split('T')[0]),lbl:mn(d.toISOString().split('T')[0]),lbs:mnS(d.toISOString().split('T')[0])})}
  const mdata=months.map(m=>{const ms=allMy.filter(s=>mkey(s.date)===m.key&&s.date<=td()&&s.status!=='cancelled');const trees=wtr(uid,ms);const rev2=wrv(uid,ms);return{...m,trees,rev:rev2,shifts:ms.length}});
  const maxM=Math.max(...mdata.map(x=>x.trees),1);const totSeason=mdata.reduce((a,x)=>a+x.trees,0);const revSeason=mdata.reduce((a,x)=>a+x.rev,0);
  document.getElementById('W-MONTHLY').innerHTML=`<div class="SUMBOX" style="margin-bottom:12px">×¡×”×´×› 6 ×—×•×“×©×™×: <strong>${totSeason} ×¢×¦×™×</strong> Â· <strong>â‚ª${revSeason.toFixed(0)}</strong> (×›×•×œ×œ × ×¡×™×¢×•×ª)</div>
    ${mdata.map(m=>`<div class="MR"><div class="MR-MO">${m.lbs}</div>
      <div class="MR-BAR"><div class="PB" style="height:13px;border-radius:7px"><div class="PF" style="background:${color};width:${(m.trees/maxM*100).toFixed(0)}%"></div></div>
        <div style="font-size:.69rem;color:var(--S);margin-top:1px">${m.shifts} ××©××¨×•×ª</div></div>
      <div class="MR-VAL">ğŸŒ¿ ${m.trees}</div></div>`).join('')}`;

  // Leaderboard â€“ current month
  const lbS=na.map(u=>({name:u.name,id:u.id,trees:wtr(u.id,curMonthSh),rev:wrv(u.id,curMonthSh)})).sort((a,b)=>b.trees-a.trees);
  document.getElementById('W-LB').innerHTML=`<div style="font-size:.78rem;color:var(--S);margin-bottom:10px;font-style:italic">×“×™×¨×•×’ ×œ×—×•×“×© ${curMonthName} â€“ ××ª××¤×¡ ×‘×›×œ ×—×•×“×©</div>`+lbS.map((r,i)=>
    `<div class="LBR ${r.id===uid?'ME':''}"><div class="LBR-RK">${M[i]||`${i+1}.`}</div>
    <div class="LBR-AV" style="background:${uc(r.id)}">${r.name.charAt(0)}</div>
    <div class="LBR-IN"><div class="LBR-NM">${r.name}${r.id===uid?' <span class="BD bv" style="font-size:.64rem">×× ×™</span>':''}</div><div class="LBR-SB">ğŸŒ¿ ${r.trees} ×¢×¦×™× Â· â‚ª${r.rev.toFixed(0)}</div></div>
    <div class="LBR-TR">ğŸŒ¿ ${r.trees}</div></div>`).join('');
}

/* â”€â”€ Self-report â”€â”€ */
function openSelfReport(sid){
  const s=DB.shifts.find(x=>x.id===sid);if(!s||!CU)return;
  document.getElementById('SELF-SID').value=sid;
  document.getElementById('SELF-DESC').textContent=`${fd(s.date)} â€“ ${s.type} | ${s.location||''}`;
  document.getElementById('SELF-TR').value=(s.wt||{})[CU.id]||'';
  document.getElementById('SELF-HR').value=(s.hours||{})[CU.id]||'';
  omo('MO-SELF');
}
function saveSelf(){
  const sid=parseInt(document.getElementById('SELF-SID').value);const s=DB.shifts.find(x=>x.id===sid);if(!s||!CU)return;
  if(!s.wt)s.wt={};if(!s.hours)s.hours={};
  s.wt[CU.id]=parseInt(document.getElementById('SELF-TR').value)||0;
  s.hours[CU.id]=parseFloat(document.getElementById('SELF-HR').value)||0;
  sdb();cmo('MO-SELF');rHome();toast('âœ… ×”× ×ª×•× ×™× ×¢×•×“×›× ×•');
}

/* â•â•â•â•â•â•â•â•â•â• MY SHIFTS â•â•â•â•â•â•â•â•â•â• */
function rMyShifts(){
  if(!CU)return;const uid=CU.id;
  const all=DB.shifts.filter(s=>s.workers.includes(uid));
  const past=all.filter(s=>s.date<=td()&&s.status!=='cancelled');
  const tot=wtr(uid,past);const rev=wrv(uid,past);const avg=past.length?(tot/past.length).toFixed(1):0;
  document.getElementById('ms-s').textContent=past.length;document.getElementById('ms-t').textContent=tot;document.getElementById('ms-a').textContent=avg;document.getElementById('ms-r').textContent='â‚ª'+rev.toFixed(0);
  document.getElementById('MS-LIST').innerHTML=[...all].sort((a,b)=>b.date.localeCompare(a.date)).map(s=>{
    const past2=s.date<td();const today2=s.date===td();const tmr2=s.date===tmr();
    const iM=s.manager===uid;const t=Number((s.wt||{})[uid]||0);const h=Number((s.hours||{})[uid]||0);
    const isD=isDriver(uid,s);const doneOrPartial2=(s.status==='full'||s.status==='partial');
    const carPayMS=isD&&doneOrPartial2?Number(s.carRate||0):0;
    const myCar=(s.cars||[]).find(c=>c.driver===uid||c.passengers?.includes(uid));
    const onLeave=workerOnLeave(uid,s.date);const borderC=today2?'var(--V)':tmr2?'var(--H)':s.status==='cancelled'?'var(--R)':past2?'var(--S)':'var(--U)';
    const hdrBg=today2?'linear-gradient(135deg,var(--V),#1e3d0a)':tmr2?'linear-gradient(135deg,var(--H),#6a4000)':s.status==='cancelled'?'linear-gradient(135deg,var(--R),#500)':past2?'linear-gradient(135deg,#5a5050,#2a2020)':'linear-gradient(135deg,var(--U),#0a3560)';
    return`<div class="WSC" style="border-right-color:${borderC}">
      <div class="WSH" style="background:${hdrBg}">
        <strong style="font-size:.84rem">${today2?'âš¡ ×”×™×•×':tmr2?'ğŸ“… ××—×¨':sd(s.date)} â€“ ${s.type}</strong>
        <div style="display:flex;gap:4px">${iM?'<span class="BD bg2">â­</span>':''}${ssBadge(s.status)}</div>
      </div>
      <div class="WSB">
        ${onLeave?'<div style="text-align:center;color:var(--R);font-weight:700;padding:6px">ğŸ–ï¸ ××ª×” ×‘×—×•×¤×© ×××•×©×¨</div>':''}
        <div class="IR"><span class="LB">ğŸ“</span><span>${s.location||'â€”'}${s.gmaps?` <a href="${s.gmaps}" target="_blank" class="ML">ğŸ—ºï¸</a>`:''}${s.waze?` <a href="${s.waze}" target="_blank" class="ML">ğŸ§­</a>`:''}</span></div>
        ${myCar?`<div class="IR"><span class="LB">ğŸš—</span><span style="font-size:.79rem">${isD?`× ×”×’ (${myCar.passengers.map(un).join(', ')||'â€”'})${doneOrPartial2?` Â· â‚ª${s.carRate||0}`:' Â· ×™×©×•×œ× ×‘×‘×™×¦×•×¢'}`:`× ×•×¡×¢ ×¢× ${un(myCar.driver)}`}${s.carKm?` Â· ${s.carKm}×§×´×`:''}</span></div>`:''}
        ${t>0?`<div class="IR"><span class="LB">ğŸŒ¿ ×¢×¦×™×:</span><span><strong style="font-size:1rem">${t}</strong> Â· ${h?h+'×© Â·':''} â‚ª${(t*s.rate+carPayMS).toFixed(0)}${carPayMS?` (×›×•×œ×œ × ×¡×™×¢×”)`:''}</span></div>`:''}
        ${(today2||tmr2||!past2)&&!onLeave&&s.status!=='cancelled'?`<button class="btn bP bXs" style="margin-top:6px" onclick="openSelfReport(${s.id})">ğŸŒ¿ ×¢×“×›×Ÿ ×¢×¦×™×</button>`:''}
      </div>
    </div>`;
  }).join('')||'<div class="EMPTY"><div class="EMJ">ğŸ“­</div><p>×¢×“×™×™×Ÿ ×œ× ×©×•×‘×¦×ª</p></div>';
}

/* â•â•â•â•â•â•â•â•â•â• MY LEAVE REQUESTS â•â•â•â•â•â•â•â•â•â• */
function rMyLeave(){
  if(!CU)return;const uid=CU.id;
  const myReqs=DB.leaveRequests.filter(r=>r.uid===uid).sort((a,b)=>b.createdAt.localeCompare(a.createdAt));
  document.getElementById('MY-LEAVE-LIST').innerHTML=myReqs.length?myReqs.map(r=>{
    const stLbl={pending:'â³ ×××ª×™×Ÿ ×œ××™×©×•×¨',approved:'âœ… ××•×©×¨',rejected:'âŒ × ×“×—×”'}[r.status];
    return`<div class="leave-req ${r.status}">
      <div style="flex:1">
        <div style="font-weight:700;font-size:.9rem">${sd(r.from)} â€“ ${sd(r.to)}</div>
        <div style="font-size:.82rem;color:var(--S);margin-top:2px">×”×•×’×©: ${sd(r.createdAt)}</div>
        ${r.note?`<div style="font-size:.8rem;font-style:italic;margin-top:3px">${r.note}</div>`:''}
      </div>
      <span class="BD ${r.status==='approved'?'bv':r.status==='rejected'?'br':'bg2'}" style="font-size:.8rem">${stLbl}</span>
    </div>`;
  }).join(''):'<div class="EMPTY"><div class="EMJ">ğŸ–ï¸</div><p>××™×Ÿ ×‘×§×©×•×ª ×—×•×¤×©</p></div>';
}
function openLeaveReq(){document.getElementById('LV-FROM').value='';document.getElementById('LV-TO').value='';document.getElementById('LV-NOTE').value='';omo('MO-LV')}
function submitLeave(){
  if(!CU)return;
  const from=document.getElementById('LV-FROM').value,to=document.getElementById('LV-TO').value;
  if(!from||!to){toast('× × ×œ×‘×—×•×¨ ×ª××¨×™×›×™×','er');return}
  if(to<from){toast('×ª××¨×™×š ×¡×™×•× ×œ×¤× ×™ ×”×ª×—×œ×”','er');return}
  DB.leaveRequests.push({id:DB.nlid++,uid:CU.id,from,to,note:document.getElementById('LV-NOTE').value,status:'pending',createdAt:td()});
  sdb();cmo('MO-LV');rMyLeave();toast('ğŸ“¤ ×”×‘×§×©×” × ×©×œ×—×” ×œ×× ×”×œ');
}
</script>
</body>
</html>
